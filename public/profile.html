<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>í”„ë¡œí•„ - ì†ì•ˆì— ê°€ì´ë“œ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234285F4'><path d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/></svg>">
    <meta name="theme-color" content="#4285F4"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://hangeul.pstatic.net">
    <link rel="stylesheet" href="https://hangeul.pstatic.net/maruburi/maruburi.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --gemini-blue: #4285F4;
        }
        html, body { 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent; 
            min-height: 100vh;
            background-color: #FFFEFA;
            font-family: 'MaruBuri', 'Pretendard', sans-serif;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        .plan-card {
            background: #f9fafb;
            border-radius: 1rem;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        .plan-card.active {
            background: linear-gradient(135deg, #4285F4 0%, #3367d6 100%);
            color: white;
            transform: scale(1.02);
        }
        .plan-card.active .plan-price { color: white; }
        .plan-card.active .plan-benefit { color: rgba(255,255,255,0.9); }
        .item-row {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .item-row:last-child { margin-bottom: 0; }
        .transaction-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .transaction-row:last-child { border-bottom: none; }
        .credit-plus { color: #10b981; font-weight: 700; }
        .credit-minus { color: #ef4444; font-weight: 700; }
        .toast-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: #1f2937;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 9999;
            max-width: 90%;
            text-align: center;
        }
        .toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 0.5rem;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .hidden { display: none !important; }
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .item-row:hover .delete-btn { opacity: 1; }
        @media (hover: none) {
            .delete-btn { opacity: 0.6; }
        }
        .text-gemini-blue { color: var(--gemini-blue); }
        
        /* âš ï¸ ìƒì„¸í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ (guideDetailPage.js ë³µë¶™ - 2025-12-11) */
        #profileDetailPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9998;
            display: flex;
            flex-direction: column;
        }
        #profileDetailPage .full-screen-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
        }
        #profileDetailPage .header-safe-area {
            position: relative;
            width: 100%;
            height: 60px;
            flex-shrink: 0;
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 1rem;
        }
        #profileDetailPage .info-fixed-area {
            position: relative;
            width: 100%;
            flex-shrink: 0;
            z-index: 25;
            padding: 0 1rem 0.5rem 1rem;
        }
        #profileDetailPage .content-safe-area {
            position: relative;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background: transparent;
            z-index: 20;
        }
        #profileDetailPage .text-content {
            padding: 1.5rem;
            line-height: 1.8;
            word-break: keep-all;
            overflow-wrap: break-word;
        }
        #profileDetailPage .readable-on-image {
            color: white;
        }
        #profileDetailPage .footer-safe-area {
            position: relative;
            width: 100%;
            height: 100px;
            flex-shrink: 0;
            z-index: 30;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            padding: 0 1rem;
            background: transparent;
        }
        #profileDetailPage .interactive-btn {
            transition: transform 0.1s ease, background-color 0.2s ease;
        }
        #profileDetailPage .interactive-btn:active {
            transform: scale(0.95);
        }
        /* êµ¬ê¸€ ë²ˆì—­ ìŠ¤í”¼ë„ˆ ì™„ì „ ìˆ¨ê¹€ (ìƒì„¸í˜ì´ì§€) */
        .goog-te-spinner-pos { display: none !important; }
    </style>
</head>
<body>
    <div id="toastContainer"></div>

    <div id="authModal" class="fixed inset-0 z-[9999] bg-gray-900/60 backdrop-blur-sm flex items-center justify-center hidden pointer-events-none">
        <div id="authModalContent" class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 transition-transform transform pointer-events-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">ë¡œê·¸ì¸</h2>
                <button id="closeAuthModalBtn" data-testid="button-close-auth-modal" class="p-2 text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <button id="kakaoLoginBtn" data-testid="button-kakao-login" class="w-full bg-[#FEE500] hover:bg-[#FDD835] text-gray-800 font-bold py-4 px-6 rounded-xl transition duration-300 shadow-lg flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 3C6.5 3 2 6.6 2 11c0 2.8 1.9 5.3 4.8 6.7-.2.7-.6 2.1-.7 2.5 0 .3.1.6.4.7.2.1.5 0 .7-.1.3-.2 3.5-2.3 4.1-2.7.6.1 1.1.1 1.7.1 5.5 0 10-3.6 10-8S17.5 3 12 3z"/>
                    </svg>
                    <span>Kakaoë¡œ ë¡œê·¸ì¸</span>
                </button>
                <button id="googleLoginBtn" data-testid="button-google-login" class="w-full bg-white border-2 border-gray-300 text-gray-800 font-bold py-4 px-6 rounded-xl hover:bg-gray-50 transition duration-300 shadow-lg flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>Googleë¡œ ë¡œê·¸ì¸</span>
                </button>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <p class="text-xs text-gray-600 text-center leading-relaxed">
                        ë¡œê·¸ì¸ ì‹œ <span class="font-semibold">ìœ„ì¹˜ì •ë³´, ì‚¬ì§„ ì •ë³´ ì‚¬ìš©</span>ì— ë™ì˜í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ’° ìºì‹œë°± ì‹ ì²­ ëª¨ë‹¬ -->
    <div id="cashbackModal" class="fixed inset-0 z-[9999] bg-gray-900/60 backdrop-blur-sm flex items-center justify-center hidden pointer-events-none">
        <div id="cashbackModalContent" class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 transition-transform transform pointer-events-auto">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">ğŸ’° ìºì‹œë°± ì‹ ì²­</h2>
                <button id="closeCashbackModalBtn" data-testid="button-close-cashback-modal" onclick="closeCashbackModal()" class="p-2 text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <!-- í˜„ì¬ í¬ë ˆë”§ ìƒíƒœ -->
                <div class="bg-blue-50 rounded-xl p-4">
                    <p class="text-sm text-gray-600">í˜„ì¬ ë³´ìœ  í¬ë ˆë”§</p>
                    <p class="text-3xl font-bold text-blue-600"><span id="cashbackCredits">0</span></p>
                </div>
                
                <!-- ìºì‹œë°± ì¡°ê±´ ì•ˆë‚´ -->
                <div id="cashbackNotEligible" class="bg-amber-50 rounded-xl p-4 hidden">
                    <div class="flex items-center gap-2 text-amber-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
                        </svg>
                        <span class="font-medium">1000 í¬ë ˆë”§ ì´ìƒ ë³´ìœ  ì‹œ ì‹ ì²­ ê°€ëŠ¥í•©ë‹ˆë‹¤</span>
                    </div>
                </div>
                
                <!-- ìºì‹œë°± ì‹ ì²­ í¼ -->
                <div id="cashbackForm" class="hidden space-y-4">
                    <div class="bg-green-50 rounded-xl p-4">
                        <div class="flex items-center gap-2 text-green-700 mb-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="font-bold">ìºì‹œë°± ê°€ëŠ¥!</span>
                        </div>
                        <p class="text-sm text-gray-600">1000 í¬ë ˆë”§ â†’ <span class="font-bold text-green-700">100 EUR í˜„ê¸ˆ í™˜ê¸‰</span></p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê²°ì œ ìˆ˜ë‹¨ (ì¹´ì¹´ì˜¤í˜ì´ or ê³„ì¢Œë²ˆí˜¸)</label>
                        <input type="text" id="cashbackPaymentMethod" class="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ì˜ˆ: ì¹´ì¹´ì˜¤í˜ì´ 01012345678" data-testid="input-payment-method">
                    </div>
                    
                    <button id="requestCashbackBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 px-6 rounded-xl hover:from-green-600 hover:to-emerald-700 transition shadow-lg" data-testid="button-request-cashback">
                        ìºì‹œë°± ì‹ ì²­í•˜ê¸°
                    </button>
                </div>
                
                <!-- ìºì‹œë°± ë‚´ì—­ -->
                <div id="cashbackHistory" class="hidden">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">ì‹ ì²­ ë‚´ì—­</h3>
                    <div id="cashbackHistoryList" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ğŸ¯ í”„ë¡œí•„ ìƒì„¸í˜ì´ì§€ (index.js ë°©ì‹ - 2025-12-11)
         race condition ë°©ì§€: synth.cancel() + renderId íŒ¨í„´
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="profileDetailPage" class="hidden">
        <img id="profileDetailImage" src="" alt="ìƒì„¸í˜ì´ì§€ ì´ë¯¸ì§€" class="full-screen-bg">
        <header class="header-safe-area">
            <button id="profileDetailBackBtn" class="w-12 h-12 flex items-center justify-center rounded-full bg-black/60 backdrop-blur-md text-gemini-blue interactive-btn shadow-2xl absolute top-1/2 right-4 -translate-y-1/2" style="z-index: 10001; pointer-events: auto;" aria-label="ë‹«ê¸°" data-testid="button-close-detail">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </header>
        <!-- ğŸ“ğŸ¤ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
        <div class="info-fixed-area">
            <div id="profileDetailLocationInfo" class="hidden flex items-center gap-2 bg-white/90 backdrop-blur-sm rounded-lg px-3 py-2 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gemini-blue flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 00.723 0l.028-.015.071-.041a16.975 16.975 0 001.144-.742 19.58 19.58 0 002.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 00-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 002.682 2.282 16.975 16.975 0 001.145.742zM12 13.5a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                <span id="profileDetailLocationName" class="text-base font-semibold text-gray-800"></span>
            </div>
            <div id="profileDetailVoiceQueryInfo" class="hidden flex items-center gap-2 bg-white/90 backdrop-blur-sm rounded-lg px-3 py-2 shadow-md mt-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gemini-blue flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.25 4.5a3.75 3.75 0 117.5 0v8.25a3.75 3.75 0 11-7.5 0V4.5z" />
                    <path d="M6 10.5a.75.75 0 01.75.75v1.5a5.25 5.25 0 1010.5 0v-1.5a.75.75 0 011.5 0v1.5a6.751 6.751 0 01-6 6.709v2.291h3a.75.75 0 010 1.5h-7.5a.75.75 0 010-1.5h3v-2.291a6.751 6.751 0 01-6-6.709v-1.5A.75.75 0 016 10.5z" />
                </svg>
                <span id="profileDetailVoiceQueryText" class="text-base font-semibold text-gray-800"></span>
            </div>
        </div>
        <div class="content-safe-area">
            <div id="profileDetailTextOverlay" class="text-content">
                <p id="profileDetailDescription" class="readable-on-image text-xl leading-relaxed"></p>
            </div>
        </div>
        <footer class="footer-safe-area">
            <button id="profileDetailAudioBtn" aria-label="ì˜¤ë””ì˜¤ ì¬ìƒ" class="w-16 h-16 flex items-center justify-center rounded-full bg-black/60 backdrop-blur-md text-gemini-blue interactive-btn shadow-2xl" data-testid="button-audio-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.648c1.295.748 1.295 2.538 0 3.286L7.279 20.99c-1.25.717-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                </svg>
            </button>
            <button id="profileDetailTextToggleBtn" aria-label="í•´ì„¤ ì½ê¸°" class="w-16 h-16 flex items-center justify-center rounded-full bg-black/60 backdrop-blur-md text-gemini-blue interactive-btn shadow-2xl" data-testid="button-text-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </button>
            <button id="profileDetailSaveBtn" aria-label="ë³´ê´€í•¨ì— ì €ì¥" class="w-16 h-16 flex items-center justify-center rounded-full bg-black/60 backdrop-blur-md text-gemini-blue interactive-btn shadow-2xl" data-testid="button-save-local">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>
            </button>
        </footer>
    </div>

    <div class="min-h-screen pb-8">
        <header class="bg-white/95 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-200/80">
            <div class="max-w-lg mx-auto px-4 py-3 flex items-center">
                <div class="w-10"></div>
                <h1 class="flex-1 text-center text-lg font-bold text-gray-900" style="font-family: 'Pretendard', sans-serif;">í”„ë¡œí•„</h1>
                <button id="backBtn" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition" data-testid="button-back">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </header>

        <main class="max-w-lg mx-auto px-4 py-4">
            <section id="profileSection" class="card">
                <div id="profileLoading" class="flex items-center gap-4">
                    <div class="skeleton w-14 h-14 rounded-full"></div>
                    <div class="flex-1">
                        <div class="skeleton h-5 w-24 mb-2"></div>
                        <div class="skeleton h-4 w-32"></div>
                    </div>
                </div>
                <div id="profileContent" class="hidden">
                    <div id="guestView" class="hidden cursor-pointer hover:bg-gray-50 transition rounded-xl" onclick="showAuthModal()" data-testid="button-guest-login">
                        <div class="flex items-center gap-4 py-2">
                            <div class="w-14 h-14 bg-gray-100 rounded-full flex items-center justify-center">
                                <svg class="w-7 h-7 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-bold text-gray-900">ë¯¸ì¸ì¦ ìƒíƒœ</p>
                                <p class="text-sm text-blue-600">íƒ­í•˜ì—¬ ë¡œê·¸ì¸</p>
                            </div>
                            <div class="text-right">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div id="userView" class="hidden">
                        <div class="flex items-center gap-4">
                            <img id="profileImage" src="" alt="í”„ë¡œí•„" class="w-14 h-14 rounded-full object-cover border-2 border-gray-100">
                            <div class="flex-1">
                                <p id="userName" class="font-bold text-gray-900" data-testid="text-username"></p>
                                <p id="userEmail" class="text-sm text-gray-500" data-testid="text-email"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-blue-600" id="creditsAmount" data-testid="text-credits">0</p>
                                <p class="text-xs text-gray-500">í¬ë ˆë”§</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="card space-y-3">
                <button id="chargeBtn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 px-4 rounded-xl hover:from-blue-600 hover:to-blue-700 transition shadow-lg" data-testid="button-charge">
                    <span id="chargeBtnText" class="text-base whitespace-nowrap notranslate" translate="no">10 EUR ì¶©ì „í•˜ê¸° (ì•½ â‚©15,000)</span>
                </button>
                
                <!-- ğŸ’° ìºì‹œë°± ì‹ ì²­ ë²„íŠ¼ (1000+ í¬ë ˆë”§ì¼ ë•Œë§Œ í‘œì‹œ) -->
                <button id="cashbackBtn" class="hidden w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-4 rounded-xl hover:from-green-600 hover:to-emerald-700 transition shadow-md" data-testid="button-cashback" onclick="openCashbackModal()">
                    <div class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z"/>
                        </svg>
                        <span>ìºì‹œë°± ì‹ ì²­ (1000 í¬ë ˆë”§ â†’ 100 EUR)</span>
                    </div>
                </button>
            </section>

            <section id="myPagesSection" class="card">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                        </svg>
                        <h2 class="font-bold text-gray-900">ë‚´ í˜ì´ì§€</h2>
                    </div>
                </div>
                <div id="pagesLoading" class="space-y-2">
                    <div class="skeleton h-14 w-full"></div>
                    <div class="skeleton h-14 w-full"></div>
                </div>
                <div id="pagesList" class="hidden">
                    <div id="detailPagesContainer"></div>
                    <div id="sharePagesContainer" class="mt-3"></div>
                    <p id="noPagesMsg" class="text-center text-gray-400 py-4 hidden">ì•„ì§ ìƒì„±í•œ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            </section>

            <section id="transactionsSection" class="card">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z"/>
                    </svg>
                    <h2 class="font-bold text-gray-900">í¬ë ˆë”§ ë‚´ì—­</h2>
                </div>
                <div id="transactionsLoading" class="space-y-2">
                    <div class="skeleton h-12 w-full"></div>
                    <div class="skeleton h-12 w-full"></div>
                </div>
                <div id="transactionsList" class="hidden"></div>
                <p id="noTransactions" class="text-center text-gray-400 py-4 hidden">ì•„ì§ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </section>


            <section id="pricingSection" class="card">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z"/>
                    </svg>
                    <h2 class="font-bold text-gray-900">ìš”ê¸ˆì œ</h2>
                </div>
                <div class="space-y-3">
                    <div class="plan-card" data-plan="free">
                        <div class="flex items-center justify-between">
                            <div class="text-left">
                                <p class="font-bold text-gray-900">ë¬´ë£Œì²´í—˜</p>
                                <p class="text-xs text-gray-500">ì‹ ê·œ ê°€ì…</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold plan-price text-blue-600">10 í¬ë ˆë”§</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 text-left">
                            <p class="text-sm plan-benefit text-gray-600">AI ì‘ë‹µ 5íšŒ</p>
                        </div>
                    </div>
                    <div class="plan-card" data-plan="standard">
                        <div class="flex items-center justify-between">
                            <div class="text-left">
                                <p class="font-bold text-gray-900">ì¼ë°˜</p>
                                <p class="text-xs text-gray-500">ì¶©ì „ ê³ ê°</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold plan-price text-blue-600">140 í¬ë ˆë”§</p>
                                <p id="standardPrice" class="text-xs text-gray-500 notranslate" translate="no">10 EUR</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 text-left">
                            <p class="text-sm plan-benefit text-gray-600">AI ì‘ë‹µ 70íšŒ</p>
                        </div>
                    </div>
                    <div class="plan-card" data-plan="pro">
                        <div class="flex items-center justify-between">
                            <div class="text-left">
                                <p class="font-bold text-gray-900">í”„ë¡œ</p>
                                <p class="text-xs text-gray-500">ê¸°ì—…/ì „ë¬¸ê°€</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold plan-price text-purple-600">ë³„ë„ í˜‘ì˜</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 text-left flex items-center justify-between">
                            <p class="text-sm plan-benefit text-gray-600">ëŒ€ìš©ëŸ‰ í¬ë ˆë”§ + ë§ì¶¤ ê¸°ëŠ¥</p>
                            <button id="contactProBtn" class="text-sm text-blue-600 font-medium hover:underline" data-testid="button-contact-pro">ë¬¸ì˜</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ê³µìœ  ëª¨ë‹¬ (index.js 2íšŒì°¨ ì„±ê³µ ëª¨ë‹¬ê³¼ ë™ì¼) -->
    <div id="shareModal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div id="shareModalContent" class="bg-white rounded-2xl max-w-md w-full shadow-2xl"></div>
    </div>

    <script>
        const toastContainer = document.getElementById('toastContainer');
        
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        }

        function isAdmin() {
            return localStorage.getItem('adminAuthenticated') === 'true';
        }

        async function loadProfile() {
            const adminMode = isAdmin();
            
            try {
                const response = await fetch('/api/profile', { credentials: 'include' });
                const data = await response.json();

                document.getElementById('profileLoading').classList.add('hidden');
                document.getElementById('profileContent').classList.remove('hidden');

                // ê´€ë¦¬ì ëª¨ë“œ UI ì ìš©
                if (adminMode) {
                    document.getElementById('creditsAmount').textContent = 'âˆ';
                    document.getElementById('chargeBtn').classList.add('hidden');
                    document.getElementById('pricingSection').classList.add('hidden');
                    
                    // ê´€ë¦¬ì ë°°ì§€ ì¶”ê°€ (userName ì˜†ì—)
                    const userNameEl = document.getElementById('userName');
                    if (userNameEl && !document.getElementById('adminBadge')) {
                        userNameEl.insertAdjacentHTML('afterend', 
                            '<span id="adminBadge" class="ml-2 px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded-full">ê´€ë¦¬ì</span>');
                    }
                }

                if (data.authenticated && data.user) {
                    document.getElementById('guestView').classList.add('hidden');
                    document.getElementById('userView').classList.remove('hidden');
                    
                    const img = document.getElementById('profileImage');
                    if (data.user.profileImageUrl) {
                        img.src = data.user.profileImageUrl;
                    } else {
                        img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%239ca3af"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>';
                    }
                    
                    document.getElementById('userName').textContent = 
                        [data.user.firstName, data.user.lastName].filter(Boolean).join(' ') || 'ì‚¬ìš©ì';
                    document.getElementById('userEmail').textContent = data.user.email || '';
                    
                    // ê´€ë¦¬ìê°€ ì•„ë‹ ë•Œë§Œ í¬ë ˆë”§ ìˆ«ì í‘œì‹œ
                    if (!adminMode) {
                        document.getElementById('creditsAmount').textContent = data.credits || 0;
                    }

                    highlightCurrentPlan(data.credits || 0);
                } else {
                    document.getElementById('guestView').classList.remove('hidden');
                    document.getElementById('userView').classList.add('hidden');
                    highlightCurrentPlan(0);
                }
            } catch (error) {
                console.error('Profile load error:', error);
                showToast('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¡œë”© ìƒíƒœ í•´ì œ
                document.getElementById('profileLoading').classList.add('hidden');
                document.getElementById('profileContent').classList.remove('hidden');
                document.getElementById('guestView').classList.remove('hidden');
                document.getElementById('userView').classList.add('hidden');
            }
        }

        async function loadPages() {
            try {
                const response = await fetch('/api/profile/pages', { credentials: 'include' });
                const data = await response.json();

                document.getElementById('pagesLoading').classList.add('hidden');
                document.getElementById('pagesList').classList.remove('hidden');

                const detailContainer = document.getElementById('detailPagesContainer');
                const shareContainer = document.getElementById('sharePagesContainer');
                
                let hasContent = false;

                if (data.detailPages && data.detailPages.length > 0) {
                    hasContent = true;
                    detailContainer.innerHTML = `
                        <p class="text-xs text-gray-500 mb-2">AI ì‘ë‹µ (${data.detailPages.length})</p>
                        ${data.detailPages.map(page => `
                            <div class="item-row cursor-pointer hover:bg-gray-100 transition" data-id="${page.id}" data-type="detail" onclick="viewGuideDetail('${page.id}')">
                                <div class="w-10 h-10 rounded-lg bg-gray-200 mr-3 overflow-hidden flex-shrink-0">
                                    ${page.thumbnail ? `<img src="${page.thumbnail}" class="w-full h-full object-cover">` : ''}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${page.title || 'ì œëª© ì—†ìŒ'}</p>
                                    <p class="text-xs text-gray-500">${formatDate(page.createdAt)}</p>
                                </div>
                                <button class="delete-btn p-2 text-gray-400 hover:text-red-500" onclick="event.stopPropagation(); deletePage('${page.id}', 'detail')">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    `;
                }

                if (data.sharePages && data.sharePages.length > 0) {
                    hasContent = true;
                    shareContainer.innerHTML = `
                        <p class="text-xs text-gray-500 mb-2">ê³µìœ í˜ì´ì§€ (${data.sharePages.length})</p>
                        ${data.sharePages.map(page => `
                            <div class="item-row cursor-pointer hover:bg-gray-100 transition" data-id="${page.id}" data-type="share" onclick="window.open('/s/${page.id}', '_blank')">
                                <div class="w-10 h-10 rounded-lg bg-gray-200 mr-3 overflow-hidden flex-shrink-0">
                                    ${page.thumbnail ? `<img src="${page.thumbnail}" class="w-full h-full object-cover">` : `
                                        <div class="w-full h-full bg-blue-100 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/>
                                            </svg>
                                        </div>
                                    `}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${page.name || 'ê³µìœ  ë§í¬'}</p>
                                    <p class="text-xs text-gray-500">${formatDate(page.createdAt)}</p>
                                </div>
                                <button class="p-2 text-blue-500 hover:text-blue-700" onclick="event.stopPropagation(); sharePage('${page.id}', '${(page.name || 'ê³µìœ  ë§í¬').replace(/'/g, "\\'")}')">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                                    </svg>
                                </button>
                                <button class="delete-btn p-2 text-gray-400 hover:text-red-500" onclick="event.stopPropagation(); deletePage('${page.id}', 'share')">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    `;
                }

                if (!hasContent) {
                    document.getElementById('noPagesMsg').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Pages load error:', error);
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¡œë”© ìƒíƒœ í•´ì œ
                document.getElementById('pagesLoading').classList.add('hidden');
                document.getElementById('pagesList').classList.remove('hidden');
                document.getElementById('noPagesMsg').classList.remove('hidden');
            }
        }

        async function deletePage(id, type) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/profile/pages/${type}/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    document.querySelector(`[data-id="${id}"][data-type="${type}"]`)?.remove();
                    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    showToast('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadTransactions() {
            try {
                const response = await fetch('/api/profile/transactions?limit=10', { credentials: 'include' });
                const data = await response.json();

                document.getElementById('transactionsLoading').classList.add('hidden');

                if (data.transactions && data.transactions.length > 0) {
                    const list = document.getElementById('transactionsList');
                    list.classList.remove('hidden');
                    list.innerHTML = data.transactions.map(tx => `
                        <div class="transaction-row">
                            <div>
                                <p class="text-sm text-gray-900">${tx.description}</p>
                                <p class="text-xs text-gray-400">${formatDate(tx.createdAt)}</p>
                            </div>
                            <div class="text-right">
                                <span class="${tx.amount > 0 ? 'credit-plus' : 'credit-minus'}">
                                    ${tx.amount > 0 ? '+' : ''}${tx.amount}
                                </span>
                                <p class="text-xs text-gray-400">ì”ì•¡ ${tx.balance}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('noTransactions').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Transactions load error:', error);
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¡œë”© ìƒíƒœ í•´ì œ
                document.getElementById('transactionsLoading').classList.add('hidden');
                document.getElementById('noTransactions').classList.remove('hidden');
            }
        }

        let cachedPriceText = '';
        let cachedBtnText = '';
        
        async function loadPricing() {
            try {
                const response = await fetch('/api/profile/exchange-rate');
                const data = await response.json();

                if (data.prices) {
                    const userLang = localStorage.getItem('appLanguage') || 'ko';
                    
                    // ì–¸ì–´ë³„ í†µí™” í‘œì‹œ
                    switch(userLang) {
                        case 'ko':
                            const krwFormatted = new Intl.NumberFormat('ko-KR').format(data.prices.KRW);
                            cachedPriceText = `10 EUR (ì•½ â‚©${krwFormatted})`;
                            cachedBtnText = `10 EUR ì¶©ì „í•˜ê¸° (ì•½ â‚©${krwFormatted})`;
                            break;
                        case 'en':
                            cachedPriceText = `10 EUR (â‰ˆ $${data.prices.USD})`;
                            cachedBtnText = `Charge 10 EUR (â‰ˆ $${data.prices.USD})`;
                            break;
                        case 'ja':
                            cachedPriceText = `10 EUR (ç´„ Â¥${new Intl.NumberFormat('ja-JP').format(data.prices.JPY)})`;
                            cachedBtnText = `10 EUR ãƒãƒ£ãƒ¼ã‚¸ (ç´„ Â¥${new Intl.NumberFormat('ja-JP').format(data.prices.JPY)})`;
                            break;
                        case 'zh-CN':
                            cachedPriceText = `10 EUR (çº¦ Â¥${data.prices.CNY})`;
                            cachedBtnText = `å……å€¼ 10 EUR (çº¦ Â¥${data.prices.CNY})`;
                            break;
                        case 'fr':
                            cachedPriceText = `10 EUR`;
                            cachedBtnText = `Recharger 10 EUR`;
                            break;
                        case 'de':
                            cachedPriceText = `10 EUR`;
                            cachedBtnText = `10 EUR aufladen`;
                            break;
                        case 'es':
                            cachedPriceText = `10 EUR`;
                            cachedBtnText = `Cargar 10 EUR`;
                            break;
                        default:
                            const defaultKrw = new Intl.NumberFormat('ko-KR').format(data.prices.KRW);
                            cachedPriceText = `10 EUR (ì•½ â‚©${defaultKrw})`;
                            cachedBtnText = `10 EUR ì¶©ì „í•˜ê¸° (ì•½ â‚©${defaultKrw})`;
                    }
                    
                    applyPriceText();
                    
                    // Google Translateê°€ í…ìŠ¤íŠ¸ë¥¼ ë®ì–´ì“°ë©´ ë‹¤ì‹œ ë³µì›
                    setTimeout(applyPriceText, 500);
                    setTimeout(applyPriceText, 1500);
                    setTimeout(applyPriceText, 3000);
                }
            } catch (error) {
                console.error('Pricing load error:', error);
            }
        }
        
        let isApplyingPrice = false;
        
        function applyPriceText() {
            if (isApplyingPrice || !cachedPriceText || !cachedBtnText) return;
            
            isApplyingPrice = true;
            const priceEl = document.getElementById('standardPrice');
            const btnEl = document.getElementById('chargeBtnText');
            
            if (priceEl && priceEl.textContent !== cachedPriceText) {
                priceEl.textContent = cachedPriceText;
            }
            if (btnEl && btnEl.textContent !== cachedBtnText) {
                btnEl.textContent = cachedBtnText;
            }
            
            setTimeout(() => { isApplyingPrice = false; }, 50);
        }
        
        // MutationObserverë¡œ Google Translate ë³€ê²½ ê°ì§€ ë° ë³µì›
        const priceObserver = new MutationObserver(() => {
            if (!isApplyingPrice) applyPriceText();
        });
        
        // í˜ì´ì§€ ë¡œë“œ í›„ Observer ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            const priceEl = document.getElementById('standardPrice');
            const btnEl = document.getElementById('chargeBtnText');
            
            if (priceEl) {
                priceObserver.observe(priceEl, { childList: true, characterData: true, subtree: true });
            }
            if (btnEl) {
                priceObserver.observe(btnEl, { childList: true, characterData: true, subtree: true });
            }
        });

        function highlightCurrentPlan(credits) {
            const cards = document.querySelectorAll('.plan-card');
            cards.forEach(card => card.classList.remove('active'));

            if (credits >= 140) {
                document.querySelector('[data-plan="standard"]')?.classList.add('active');
            } else if (credits > 0) {
                document.querySelector('[data-plan="free"]')?.classList.add('active');
            }
        }

        document.getElementById('backBtn').addEventListener('click', () => {
            window.close();
        });

        function showAuthModal() {
            const modal = document.getElementById('authModal');
            modal.classList.remove('hidden');
            modal.classList.remove('pointer-events-none');
            modal.classList.add('pointer-events-auto');
        }

        function hideAuthModal() {
            const modal = document.getElementById('authModal');
            modal.classList.add('hidden');
            modal.classList.add('pointer-events-none');
            modal.classList.remove('pointer-events-auto');
        }

        document.getElementById('kakaoLoginBtn').addEventListener('click', () => {
            sessionStorage.setItem('authRedirect', '/profile.html');
            window.location.href = '/api/auth/kakao';
        });

        document.getElementById('googleLoginBtn').addEventListener('click', () => {
            sessionStorage.setItem('authRedirect', '/profile.html');
            window.location.href = '/api/auth/google';
        });

        document.getElementById('closeAuthModalBtn').addEventListener('click', hideAuthModal);

        document.getElementById('authModal').addEventListener('click', (e) => {
            if (e.target.id === 'authModal') hideAuthModal();
        });

        document.getElementById('chargeBtn').addEventListener('click', async () => {
            const btn = document.getElementById('chargeBtn');
            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">ì²˜ë¦¬ ì¤‘...</span>';

            try {
                const response = await fetch('/api/profile/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.error) {
                    if (response.status === 401) {
                        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        setTimeout(() => window.location.href = '/api/auth/google', 1500);
                    } else {
                        showToast(data.error);
                    }
                } else if (data.url) {
                    window.location.href = data.url;
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showToast('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });

        document.getElementById('contactProBtn')?.addEventListener('click', () => {
            window.location.href = 'mailto:dbstour1@gmail.com?subject=[ì†ì•ˆì— ê°€ì´ë“œ] í”„ë¡œí”Œëœ ë¬¸ì˜';
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âš ï¸ guideDetailPage.js ë³µë¶™ (2025-12-11)
        // profile.htmlìš©: profileDetailPage ê°ì²´
        // _saveToLocal ìˆ˜ì •: ì €ì¥ë§Œ, í˜ì´ì§€ ì´ë™/ë‹«ê¸° ì—†ìŒ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const profileDetailPage = {
            // ğŸ”’ ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€
            _isInitialized: false,
            
            // ë‚´ë¶€ ìƒíƒœ
            _state: {
                isTextVisible: true,
                synth: null,
                voices: [],
                currentUtterance: null,
                originalText: '',
                onClose: null,
                translationComplete: true,
                translationObserver: null,
                voiceConfigsCache: null,
                voiceConfigsLoading: false,
                currentGuideData: null,
                onSave: null,
                renderId: 0,
                savedVoiceLang: null,
                savedVoiceName: null
            },
            
            // ğŸ”Š í•˜ë“œì½”ë”© ê¸°ë³¸ê°’ (ì˜¤í”„ë¼ì¸ fallback)
            _defaultVoicePriorities: {
                'ko-KR': { default: ['Microsoft Heami', 'Yuna'] },
                'en-US': { default: ['Samantha', 'Microsoft Zira', 'Google US English', 'English'] },
                'ja-JP': { default: ['Kyoko', 'Microsoft Haruka', 'Google æ—¥æœ¬èª', 'Japanese'] },
                'zh-CN': { default: ['Ting-Ting', 'Microsoft Huihui', 'Google æ™®é€šè¯', 'Chinese'] },
                'fr-FR': { default: ['Thomas', 'Microsoft Hortense', 'Google franÃ§ais', 'French'] },
                'de-DE': { default: ['Anna', 'Microsoft Hedda', 'Google Deutsch', 'German'] },
                'es-ES': { default: ['Monica', 'Microsoft Helena', 'Google espaÃ±ol', 'Spanish'] }
            },

            // ì´ˆê¸°í™” (ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
            init: function(options = {}) {
                // ğŸ”’ ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€
                if (this._isInitialized) {
                    console.log('[ProfileDetailPage] ì´ë¯¸ ì´ˆê¸°í™”ë¨, ìŠ¤í‚µ');
                    return;
                }
                this._isInitialized = true;
                
                const self = this;
                this._state.synth = window.speechSynthesis;
                this._state.onClose = options.onClose || null;

                // DOM ìš”ì†Œ
                this._els = {
                    page: document.getElementById('profileDetailPage'),
                    image: document.getElementById('profileDetailImage'),
                    description: document.getElementById('profileDetailDescription'),
                    locationInfo: document.getElementById('profileDetailLocationInfo'),
                    locationName: document.getElementById('profileDetailLocationName'),
                    voiceQueryInfo: document.getElementById('profileDetailVoiceQueryInfo'),
                    voiceQueryText: document.getElementById('profileDetailVoiceQueryText'),
                    textOverlay: document.getElementById('profileDetailTextOverlay'),
                    audioBtn: document.getElementById('profileDetailAudioBtn'),
                    textToggleBtn: document.getElementById('profileDetailTextToggleBtn'),
                    backBtn: document.getElementById('profileDetailBackBtn'),
                    saveBtn: document.getElementById('profileDetailSaveBtn')
                };

                this._state.onSave = options.onSave || null;

                // ìŒì„± ëª©ë¡ ë¡œë“œ
                this._populateVoiceList();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = () => self._populateVoiceList();
                }

                // DBì—ì„œ ìŒì„± ì„¤ì • ë¡œë“œ
                this._loadVoiceConfigsFromDB();

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                this._els.backBtn.addEventListener('click', () => self.close());
                this._els.audioBtn.addEventListener('click', () => self._toggleAudio());
                this._els.textToggleBtn.addEventListener('click', () => { self._stopAudio(); self._toggleText(); });
                this._els.saveBtn.addEventListener('click', () => { self._stopAudio(); self._saveToLocal(); });

                // ë²ˆì—­ ì™„ë£Œ ê°ì§€ ì´ˆê¸°í™”
                this._initTranslationWatcher();

                console.log('[ProfileDetailPage] Initialized');
            },
            
            // ğŸ”Š DBì—ì„œ ìŒì„± ì„¤ì • ë¡œë“œ
            _loadVoiceConfigsFromDB: async function() {
                if (this._state.voiceConfigsCache) return this._state.voiceConfigsCache;
                if (this._state.voiceConfigsLoading) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return this._state.voiceConfigsCache || null;
                }
                
                this._state.voiceConfigsLoading = true;
                try {
                    const response = await fetch('/api/voice-configs');
                    if (response.ok) {
                        const configs = await response.json();
                        this._state.voiceConfigsCache = {};
                        for (const config of configs) {
                            if (!this._state.voiceConfigsCache[config.langCode]) {
                                this._state.voiceConfigsCache[config.langCode] = {};
                            }
                            this._state.voiceConfigsCache[config.langCode][config.platform] = {
                                priorities: config.voicePriorities,
                                excludeVoices: config.excludeVoices || []
                            };
                        }
                        console.log('ğŸ”Š [ProfileDetailPage Voice DB] ì„¤ì • ë¡œë“œ ì™„ë£Œ:', Object.keys(this._state.voiceConfigsCache));
                    }
                } catch (error) {
                    console.warn('ğŸ”Š [ProfileDetailPage Voice DB] ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error.message);
                }
                this._state.voiceConfigsLoading = false;
                return this._state.voiceConfigsCache;
            },
            
            // ğŸ”Š í”Œë«í¼ ê°ì§€
            _detectPlatform: function() {
                const ua = navigator.userAgent;
                if (/iPhone|iPad|iPod|Mac/.test(ua)) return 'ios';
                if (/Android/.test(ua)) return 'android';
                if (/Windows/.test(ua)) return 'windows';
                return 'default';
            },
            
            // ğŸ”Š DB ê¸°ë°˜ ìŒì„± ìš°ì„ ìˆœìœ„ ê°€ì ¸ì˜¤ê¸°
            _getVoicePriorityFromDB: function(langCode) {
                const platform = this._detectPlatform();
                
                if (this._state.voiceConfigsCache && this._state.voiceConfigsCache[langCode]) {
                    const config = this._state.voiceConfigsCache[langCode][platform] || this._state.voiceConfigsCache[langCode]['default'];
                    if (config) {
                        return { priorities: config.priorities, excludeVoices: config.excludeVoices };
                    }
                }
                
                const fallback = this._defaultVoicePriorities[langCode];
                if (fallback) {
                    const priorities = fallback[platform] || fallback['default'] || fallback[Object.keys(fallback)[0]];
                    return { priorities, excludeVoices: [] };
                }
                
                return { priorities: [], excludeVoices: [] };
            },

            // ğŸŒ ë²ˆì—­ ì™„ë£Œ ê°ì§€ (MutationObserver)
            _initTranslationWatcher: function() {
                const self = this;
                const userLang = localStorage.getItem('appLanguage') || 'ko';
                
                if (userLang === 'ko') {
                    this._state.translationComplete = true;
                    return;
                }
                
                const hasTranslateClass = document.body.classList.contains('translated-ltr') || 
                                          document.body.classList.contains('translated-rtl');
                if (hasTranslateClass) {
                    this._state.translationComplete = true;
                    return;
                }
                
                this._state.translationComplete = false;
                
                this._state.translationObserver = new MutationObserver(function(mutations) {
                    const hasTranslated = document.body.classList.contains('translated-ltr') || 
                                          document.body.classList.contains('translated-rtl');
                    if (hasTranslated) {
                        self._state.translationComplete = true;
                        self._state.translationObserver.disconnect();
                        window.dispatchEvent(new CustomEvent('profileTranslationComplete'));
                    }
                });
                
                this._state.translationObserver.observe(document.body, { 
                    attributes: true, 
                    attributeFilter: ['class'] 
                });
                
                setTimeout(function() {
                    if (!self._state.translationComplete) {
                        self._state.translationComplete = true;
                        if (self._state.translationObserver) {
                            self._state.translationObserver.disconnect();
                        }
                        window.dispatchEvent(new CustomEvent('profileTranslationComplete', { detail: { timeout: true } }));
                    }
                }, 3000);
            },

            // ìŒì„± ëª©ë¡ ë¡œë“œ
            _populateVoiceList: function() {
                this._state.voices = this._state.synth.getVoices();
            },
            
            // ì–¸ì–´ë³„ ìŒì„± ì„ íƒ
            _getVoiceForLanguage: function(userLang) {
                const langMap = {
                    'ko': 'ko-KR', 'en': 'en-US', 'ja': 'ja-JP', 'zh-CN': 'zh-CN',
                    'fr': 'fr-FR', 'de': 'de-DE', 'es': 'es-ES'
                };
                
                const fullLang = langMap[userLang] || 'ko-KR';
                const langCode = fullLang.substring(0, 2);
                
                const voiceConfig = this._getVoicePriorityFromDB(fullLang);
                const priorities = voiceConfig.priorities;
                const excludeVoices = voiceConfig.excludeVoices;
                
                const allVoices = this._state.voices;
                let targetVoice = null;
                
                for (const voiceName of priorities) {
                    targetVoice = allVoices.find(v => 
                        v.name.includes(voiceName) && !excludeVoices.some(ex => v.name.includes(ex))
                    );
                    if (targetVoice) break;
                }
                
                if (!targetVoice) {
                    targetVoice = allVoices.find(v => 
                        v.lang.replace('_', '-').startsWith(langCode) && !excludeVoices.some(ex => v.name.includes(ex))
                    );
                }
                
                return targetVoice || allVoices[0];
            },

            // í˜ì´ì§€ ì—´ê¸° (guideIdë¡œ API í˜¸ì¶œ)
            open: async function(guideId) {
                // ğŸ”’ 2025-12-12: ê°•ì œ ì´ˆê¸°í™” - ì´ì „ ìŒì„±/ë°ì´í„° ì™„ì „ ì •ë¦¬
                if (this._state.synth) {
                    this._state.synth.cancel();
                }
                this._stopAudio();
                
                // ìƒíƒœ ì´ˆê¸°í™”
                this._state.currentGuideData = null;
                this._state.savedVoiceLang = null;
                this._state.savedVoiceName = null;
                this._state.originalText = '';
                this._state.currentUtterance = null;
                
                // ë Œë” ID ì¦ê°€ - ì´ì „ ì½œë°± ë¬´íš¨í™”
                this._state.renderId++;
                const thisRenderId = this._state.renderId;
                
                console.log('[ProfileDetailPage] open() guideId:', guideId, 'renderId:', thisRenderId);
                
                try {
                    this._show();
                    
                    if (this._els.description) {
                        this._els.description.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                    }
                    this._els.image.src = '';
                    this._els.locationInfo.classList.add('hidden');
                    if (this._els.voiceQueryInfo) this._els.voiceQueryInfo.classList.add('hidden');

                    const response = await fetch(`/api/guides/${guideId}`, { credentials: 'include' });
                    if (!response.ok) throw new Error('ê°€ì´ë“œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    
                    const guide = await response.json();
                    
                    if (thisRenderId !== this._state.renderId) {
                        console.log('[ProfileDetailPage] ë Œë” ID ë¶ˆì¼ì¹˜, ë¬´ì‹œ');
                        return;
                    }
                    
                    this._state.currentGuideData = guide;
                    this._render(guide, thisRenderId);
                } catch (error) {
                    console.error('[ProfileDetailPage] Error:', error);
                    this._els.description.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
                }
            },

            // ë Œë”ë§
            _render: function(guide, renderId) {
                const isVoiceGuide = (!guide.imageUrl && !guide.imageDataUrl) && (guide.voiceQuery || guide.title);
                const imageUrl = guide.imageUrl || guide.imageDataUrl || '/images/landing-logo.jpg';
                this._els.image.src = imageUrl;
                
                if (!guide.imageUrl && !guide.imageDataUrl) {
                    this._els.image.style.filter = 'blur(8px) brightness(0.7)';
                    this._els.image.style.transform = 'scale(1.1)';
                } else {
                    this._els.image.style.filter = '';
                    this._els.image.style.transform = '';
                }
                
                this._els.description.textContent = guide.description || 'ë‚´ìš© ì—†ìŒ';
                
                if (isVoiceGuide) {
                    this._els.locationInfo.classList.add('hidden');
                    if (this._els.voiceQueryInfo && this._els.voiceQueryText) {
                        this._els.voiceQueryText.textContent = guide.voiceQuery || guide.title || '';
                        this._els.voiceQueryInfo.classList.remove('hidden');
                    }
                } else {
                    if (this._els.voiceQueryInfo) {
                        this._els.voiceQueryInfo.classList.add('hidden');
                    }
                    if (guide.locationName) {
                        this._els.locationName.textContent = guide.locationName;
                        this._els.locationInfo.classList.remove('hidden');
                    } else {
                        this._els.locationInfo.classList.add('hidden');
                    }
                }

                this._state.savedVoiceLang = guide.voiceLang || null;
                this._state.savedVoiceName = guide.voiceName || null;

                if (guide.description) {
                    this._playAudio(guide.description, guide.voiceLang, guide.voiceName, renderId);
                }
            },

            // í˜ì´ì§€ í‘œì‹œ
            _show: function() {
                this._els.page.classList.remove('hidden');
                document.documentElement.style.overflow = 'hidden';
                document.body.style.overflow = 'hidden';
                this._refreshTranslationState();
            },
            
            // ë²ˆì—­ ìƒíƒœ ì¬í™•ì¸
            _refreshTranslationState: function() {
                const self = this;
                const userLang = localStorage.getItem('appLanguage') || 'ko';
                
                if (userLang === 'ko') {
                    this._state.translationComplete = true;
                    return;
                }
                
                const hasTranslateClass = document.body.classList.contains('translated-ltr') || 
                                          document.body.classList.contains('translated-rtl');
                if (hasTranslateClass) {
                    this._state.translationComplete = true;
                    return;
                }
                
                this._state.translationComplete = false;
                
                if (this._state.translationObserver) {
                    this._state.translationObserver.disconnect();
                }
                
                this._state.translationObserver = new MutationObserver(function(mutations) {
                    const hasTranslated = document.body.classList.contains('translated-ltr') || 
                                          document.body.classList.contains('translated-rtl');
                    if (hasTranslated) {
                        self._state.translationComplete = true;
                        self._state.translationObserver.disconnect();
                        window.dispatchEvent(new CustomEvent('profileTranslationComplete'));
                    }
                });
                
                this._state.translationObserver.observe(document.body, { 
                    attributes: true, 
                    attributeFilter: ['class'] 
                });
            },

            // í˜ì´ì§€ ë‹«ê¸°
            close: function() {
                this._stopAudio();
                this._els.page.classList.add('hidden');
                document.documentElement.style.overflow = '';
                document.body.style.overflow = '';
                
                if (this._state.onClose) {
                    this._state.onClose();
                }
            },

            // ìŒì„± ì¬ìƒ (ë¬¸ì¥ë³„ í•˜ì´ë¼ì´íŠ¸ + ìë™ ìŠ¤í¬ë¡¤)
            _playAudio: async function(text, savedVoiceLang, savedVoiceName, renderId) {
                const self = this;
                const thisRenderId = renderId || this._state.renderId;
                this._stopAudio();
                
                const userLang = localStorage.getItem('appLanguage') || 'ko';
                if (userLang !== 'ko' && !this._state.translationComplete) {
                    await new Promise(resolve => {
                        const handler = () => {
                            window.removeEventListener('profileTranslationComplete', handler);
                            resolve();
                        };
                        window.addEventListener('profileTranslationComplete', handler);
                        setTimeout(resolve, 3500);
                    });
                }
                
                const currentText = this._els.description.textContent || text;
                const cleanText = currentText.replace(new RegExp('<br\\s*/?>', 'gi'), ' ');
                const sentences = cleanText.match(/[^.!?]+[.!?]+/g) || [cleanText];
                
                this._state.originalText = cleanText;
                this._state.currentUtterance = new SpeechSynthesisUtterance(cleanText);
                
                const langFullMap = { 'ko': 'ko-KR', 'en': 'en-US', 'ja': 'ja-JP', 'zh-CN': 'zh-CN', 'fr': 'fr-FR', 'de': 'de-DE', 'es': 'es-ES' };
                const fullLang = (userLang !== 'ko') ? (langFullMap[userLang] || 'ko-KR') : (savedVoiceLang || 'ko-KR');
                
                let voices = this._state.synth.getVoices();
                if (voices.length === 0) {
                    await new Promise(resolve => {
                        const checkVoices = () => {
                            voices = self._state.synth.getVoices();
                            if (voices.length > 0) resolve();
                            else setTimeout(checkVoices, 100);
                        };
                        setTimeout(checkVoices, 100);
                        setTimeout(resolve, 1000);
                    });
                    voices = this._state.synth.getVoices();
                }
                this._state.voices = voices;
                
                let targetVoice = null;
                const shortLang = fullLang.substring(0, 2);
                
                if (shortLang === 'ko') {
                    // ğŸ”Š 2025-12-12: ì •í™•í•œ í•œêµ­ì–´ ìš°ì„ ìˆœìœ„ (Microsoft Heami â†’ Yuna)
                    const koVoices = voices.filter(v => v.lang.startsWith('ko'));
                    targetVoice = koVoices.find(v => v.name.includes('Heami'))
                               || koVoices.find(v => v.name.includes('Yuna'))
                               || koVoices[0];
                    console.log('[ProfileDetailPage TTS] í•œêµ­ì–´ ìŒì„±:', targetVoice?.name);
                } else {
                    targetVoice = this._getVoiceForLanguage(shortLang === 'zh' ? 'zh-CN' : shortLang);
                }
                
                this._state.currentUtterance.voice = targetVoice;
                this._state.currentUtterance.lang = fullLang;
                this._state.currentUtterance.rate = 1.0;
                
                let currentSentenceIndex = 0;
                
                this._state.currentUtterance.onstart = () => {
                    self._updateAudioButtonIcon(true);
                };
                
                this._state.currentUtterance.onboundary = (event) => {
                    if (thisRenderId !== self._state.renderId) return;
                    
                    if (event.name === 'sentence') {
                        const highlightedHTML = sentences.map((sentence, idx) => {
                            if (idx === currentSentenceIndex) {
                                return '<span class="current-sentence" style="background-color: rgba(66, 133, 244, 0.3); font-weight: 600;">' + sentence + '</span>';
                            }
                            return sentence;
                        }).join('');
                        
                        self._els.description.innerHTML = highlightedHTML;
                        currentSentenceIndex++;
                        
                        const currentSpan = self._els.description.querySelector('.current-sentence');
                        if (currentSpan) {
                            currentSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                };
                
                this._state.currentUtterance.onend = () => {
                    if (thisRenderId !== self._state.renderId) return;
                    self._updateAudioButtonIcon(false);
                    self._els.description.textContent = self._state.originalText;
                };
                
                this._state.synth.speak(this._state.currentUtterance);
            },

            // ìŒì„± ì •ì§€
            _stopAudio: function() {
                if (this._state.currentUtterance) {
                    this._state.currentUtterance.onboundary = null;
                    this._state.currentUtterance.onend = null;
                    this._state.currentUtterance.onstart = null;
                    this._state.currentUtterance.onerror = null;
                }
                if (this._state.synth.speaking) {
                    this._state.synth.pause();
                    this._state.synth.cancel();
                }
                this._updateAudioButtonIcon(false);
                if (this._state.originalText && this._els.description) {
                    this._els.description.textContent = this._state.originalText;
                }
            },

            // ìŒì„± í† ê¸€
            _toggleAudio: function() {
                const text = this._els.description.textContent;
                if (!text || text === 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...') return;

                if (this._state.synth.speaking) {
                    this._stopAudio();
                } else {
                    this._playAudio(text, this._state.savedVoiceLang, this._state.savedVoiceName);
                }
            },

            // ì˜¤ë””ì˜¤ ë²„íŠ¼ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            _updateAudioButtonIcon: function(isPlaying) {
                this._els.audioBtn.innerHTML = isPlaying ? `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 01.75-.75H9a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H7.5a.75.75 0 01-.75-.75V5.25zm7.5 0A.75.75 0 0115 4.5h1.5a.75.75 0 01.75.75v13.5a.75.75 0 01-.75.75H15a.75.75 0 01-.75-.75V5.25z" clip-rule="evenodd" />
                    </svg>
                ` : `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.648c1.295.748 1.295 2.538 0 3.286L7.279 20.99c-1.25.717-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
                    </svg>
                `;
            },

            // í…ìŠ¤íŠ¸ í† ê¸€
            _toggleText: function() {
                this._state.isTextVisible = !this._state.isTextVisible;
                this._els.textOverlay.style.opacity = this._state.isTextVisible ? '1' : '0';
            },

            // ğŸ’¾ ë¡œì»¬ ë³´ê´€í•¨(IndexedDB)ì— ì €ì¥ (ì €ì¥ë§Œ, í˜ì´ì§€ ì´ë™ ì—†ìŒ)
            _saveToLocal: async function() {
                const data = this._state.currentGuideData;
                if (!data) {
                    console.warn('[ProfileDetailPage] ì €ì¥í•  ë°ì´í„° ì—†ìŒ');
                    showToast('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }

                this._els.saveBtn.disabled = true;
                this._els.saveBtn.style.opacity = '0.5';

                try {
                    const guideData = {
                        imageDataUrl: data.imageUrl || data.imageDataUrl || '',
                        description: data.description || '',
                        locationName: data.locationName || '',
                        voiceLang: data.voiceLang || this._state.savedVoiceLang || 'ko-KR',
                        voiceName: data.voiceName || this._state.savedVoiceName || '',
                        title: data.title || data.voiceQuery || 'ì œëª© ì—†ìŒ',
                        timestamp: Date.now()
                    };

                    const savedId = await this._addToIndexedDB(guideData);
                    console.log('[ProfileDetailPage] IndexedDB ì €ì¥ ì™„ë£Œ, ID:', savedId);
                    
                    showToast('ë³´ê´€í•¨ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                    
                    // âœ… ì €ì¥ë§Œ í•˜ê³  í˜ì´ì§€ ì´ë™/ë‹«ê¸° ì—†ìŒ
                    this._els.saveBtn.disabled = false;
                    this._els.saveBtn.style.opacity = '1';
                    
                } catch (error) {
                    console.error('[ProfileDetailPage] ì €ì¥ ì‹¤íŒ¨:', error);
                    showToast('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    this._els.saveBtn.disabled = false;
                    this._els.saveBtn.style.opacity = '1';
                }
            },

            // IndexedDBì— ì•„ì´í…œ ì¶”ê°€
            _addToIndexedDB: function(item) {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('MyAppDB', 1);
                    
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('archive')) {
                            db.createObjectStore('archive', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    
                    request.onsuccess = (e) => {
                        const db = e.target.result;
                        const tx = db.transaction('archive', 'readwrite');
                        const store = tx.objectStore('archive');
                        const addRequest = store.add(item);
                        
                        addRequest.onsuccess = () => resolve(addRequest.result);
                        addRequest.onerror = () => reject(addRequest.error);
                    };
                    
                    request.onerror = () => reject(request.error);
                });
            }
        };
        
        profileDetailPage.init();
        
        function viewGuideDetail(guideId) {
            profileDetailPage.open(guideId);
        }

        // ê³µìœ  ê¸°ëŠ¥ (index.js 2íšŒì°¨ ì„±ê³µ ëª¨ë‹¬ê³¼ ë™ì¼)
        const shareModal = document.getElementById('shareModal');
        const shareModalContent = document.getElementById('shareModalContent');

        async function sharePage(pageId, pageName) {
            const shareUrl = `${window.location.origin}/s/${pageId}`;
            
            // ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ ì‹œë„
            let copySuccess = false;
            try {
                await navigator.clipboard.writeText(shareUrl);
                copySuccess = true;
            } catch (err) {
                // fallback ì‹œë„
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    copySuccess = true;
                } catch (e) {
                    console.warn('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', e);
                }
            }

            // âœ… ê³µìœ  ëª¨ë‹¬ 2ë²ˆì§¸ íŒì—… í‘œì‹œ (ì„±ê³µ ë©”ì‹œì§€) - index.jsì™€ ë™ì¼
            shareModalContent.innerHTML = `
                <div class="p-8 text-center">
                    <div class="w-20 h-20 mx-auto mb-6 bg-green-100 rounded-full flex items-center justify-center">
                        <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-4">ë§í¬ ë³µì‚¬ ì™„ë£Œ!</h3>
                    ${copySuccess ? `
                        <p class="text-lg text-gray-700 mb-3">âœ… ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤</p>
                        <p class="text-base text-gray-600">ì¹´ì¹´ì˜¤í†¡, ë¬¸ì, ë©”ì‹ ì € ë“±<br>ì›í•˜ëŠ” ê³³ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”!</p>
                    ` : `
                        <p class="text-base text-gray-700 mb-4">ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•´ì„œ ê³µìœ í•˜ì„¸ìš”:</p>
                        <div class="bg-gray-100 p-4 rounded-lg mb-3">
                            <p class="text-sm font-mono text-gray-800 break-all">${shareUrl}</p>
                        </div>
                        <button id="manualCopyBtn" data-url="${shareUrl}"
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            ë§í¬ ë³µì‚¬í•˜ê¸°
                        </button>
                    `}
                </div>
            `;
            
            shareModal.classList.remove('hidden');

            // ìˆ˜ë™ ë³µì‚¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í´ë¦½ë³´ë“œ ì‹¤íŒ¨ ì‹œ)
            if (!copySuccess) {
                const manualBtn = document.getElementById('manualCopyBtn');
                if (manualBtn) {
                    manualBtn.onclick = async () => {
                        try {
                            await navigator.clipboard.writeText(shareUrl);
                            manualBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ!';
                            setTimeout(() => {
                                shareModal.classList.add('hidden');
                            }, 1000);
                        } catch (err) {
                            showToast('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
                        }
                    };
                }
            }

            // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ëª¨ë‹¬ ë‹«ê¸°
            setTimeout(() => {
                shareModal.classList.add('hidden');
            }, 3000);

            // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
            shareModal.onclick = (e) => {
                if (e.target === shareModal) {
                    shareModal.classList.add('hidden');
                }
            };
        }

        const urlParams = new URLSearchParams(window.location.search);
        const paymentStatus = urlParams.get('payment');
        const sessionId = urlParams.get('session_id');

        if (paymentStatus === 'success' && sessionId) {
            // ê²°ì œ í™•ì¸ ë° í¬ë ˆë”§ ì¶©ì „
            showToast('ê²°ì œ í™•ì¸ ì¤‘...');
            fetch('/api/profile/verify-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ sessionId })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast(`âœ… ${result.added || 140} í¬ë ˆë”§ì´ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    loadProfile();
                    loadTransactions();
                } else {
                    showToast(result.message || result.error || 'ê²°ì œ í™•ì¸ ì™„ë£Œ');
                }
            })
            .catch(error => {
                console.error('Payment verification error:', error);
                showToast('ê²°ì œ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
            window.history.replaceState({}, document.title, '/profile.html');
        } else if (paymentStatus === 'cancel') {
            showToast('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.history.replaceState({}, document.title, '/profile.html');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ’° ìºì‹œë°± ëª¨ë‹¬ ì œì–´ (2025-11-29 ê°„ì†Œí™”)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        function openCashbackModal() {
            const modal = document.getElementById('cashbackModal');
            modal.classList.remove('hidden', 'pointer-events-none');
            loadCashbackInfo();
        }
        
        function closeCashbackModal() {
            const modal = document.getElementById('cashbackModal');
            modal.classList.add('hidden', 'pointer-events-none');
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('cashbackModal').addEventListener('click', (e) => {
            if (e.target.id === 'cashbackModal') closeCashbackModal();
        });
        
        // ìºì‹œë°± ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ (í¬ë ˆë”§ 1000 ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ)
        function updateCashbackButtonVisibility(credits) {
            const cashbackBtn = document.getElementById('cashbackBtn');
            if (credits >= 1000) {
                cashbackBtn.classList.remove('hidden');
            } else {
                cashbackBtn.classList.add('hidden');
            }
        }
        
        async function loadCashbackInfo() {
            try {
                const [profileRes, historyRes] = await Promise.all([
                    fetch('/api/profile', { credentials: 'include' }),
                    fetch('/api/profile/cashback/history', { credentials: 'include' })
                ]);
                
                const profileData = await profileRes.json();
                const historyData = await historyRes.json();
                
                const credits = profileData.credits || 0;
                document.getElementById('cashbackCredits').textContent = credits;
                
                // ìºì‹œë°± ë²„íŠ¼ í‘œì‹œ ì—…ë°ì´íŠ¸
                updateCashbackButtonVisibility(credits);
                
                if (credits >= 1000) {
                    document.getElementById('cashbackForm').classList.remove('hidden');
                    document.getElementById('cashbackNotEligible').classList.add('hidden');
                } else {
                    document.getElementById('cashbackForm').classList.add('hidden');
                    document.getElementById('cashbackNotEligible').classList.remove('hidden');
                }
                
                // ìºì‹œë°± ë‚´ì—­ í‘œì‹œ
                if (historyData.requests && historyData.requests.length > 0) {
                    document.getElementById('cashbackHistory').classList.remove('hidden');
                    document.getElementById('cashbackHistoryList').innerHTML = historyData.requests.map(req => {
                        const statusText = {
                            'pending': 'â³ ëŒ€ê¸°ì¤‘',
                            'approved': 'âœ… ìŠ¹ì¸',
                            'rejected': 'âŒ ê±°ì ˆ'
                        }[req.status] || req.status;
                        
                        return `
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="text-sm font-medium">${req.creditsAmount} í¬ë ˆë”§ â†’ ${(req.cashAmount / 100).toFixed(0)} EUR</span>
                                    <span class="text-xs">${statusText}</span>
                                </div>
                                <p class="text-xs text-gray-500">${new Date(req.createdAt).toLocaleDateString('ko-KR')}</p>
                                ${req.adminNote ? `<p class="text-xs text-gray-600 mt-1">${req.adminNote}</p>` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('cashbackHistory').classList.add('hidden');
                }
            } catch (error) {
                console.error('Cashback info load error:', error);
            }
        }
        
        // ìºì‹œë°± ì‹ ì²­
        document.getElementById('requestCashbackBtn').onclick = async () => {
            const paymentMethod = document.getElementById('cashbackPaymentMethod').value.trim();
            
            if (!paymentMethod) {
                showToast('ê²°ì œ ìˆ˜ë‹¨ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('/api/profile/cashback/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ paymentMethod, paymentInfo: paymentMethod })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('ìºì‹œë°± ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    document.getElementById('cashbackPaymentMethod').value = '';
                    closeCashbackModal();
                    loadCashbackInfo();
                    loadTransactions();
                    loadProfile();
                } else {
                    showToast(result.error || 'ìºì‹œë°± ì‹ ì²­ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Cashback request error:', error);
                showToast('ìºì‹œë°± ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };

        loadProfile();
        loadPages();
        loadTransactions();
        loadPricing();
        loadCashbackInfo();

        // âœ… 2025-11-28: íƒ­ í¬ì»¤ìŠ¤ ì‹œ ì¸ì¦/í¬ë ˆë”§ ìƒíƒœ ì‹¤ì‹œê°„ ê°±ì‹ 
        // ë©”ì¸ì•± â†” í”„ë¡œí•„ í˜ì´ì§€ ê°„ ì„¸ì…˜ ì—°ë™
        window.addEventListener('focus', () => {
            loadProfile();
            loadTransactions();
            loadCashbackInfo();
        });
        window.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                loadProfile();
                loadTransactions();
                loadCashbackInfo();
            }
        });
    </script>
</body>
</html>
