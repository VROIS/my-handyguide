<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>프로필 - 손안에 가이드</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234285F4'><path d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/></svg>">
    <meta name="theme-color" content="#4285F4"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://hangeul.pstatic.net">
    <link rel="stylesheet" href="https://hangeul.pstatic.net/maruburi/maruburi.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --gemini-blue: #4285F4;
        }
        html, body { 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent; 
            min-height: 100vh;
            background-color: #FFFEFA;
            font-family: 'MaruBuri', 'Pretendard', sans-serif;
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        .plan-card {
            background: #f9fafb;
            border-radius: 1rem;
            padding: 1.25rem;
            text-align: center;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        .plan-card.active {
            background: linear-gradient(135deg, #4285F4 0%, #3367d6 100%);
            color: white;
            transform: scale(1.02);
        }
        .plan-card.active .plan-price { color: white; }
        .plan-card.active .plan-benefit { color: rgba(255,255,255,0.9); }
        .item-row {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .item-row:last-child { margin-bottom: 0; }
        .transaction-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .transaction-row:last-child { border-bottom: none; }
        .credit-plus { color: #10b981; font-weight: 700; }
        .credit-minus { color: #ef4444; font-weight: 700; }
        .toast-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: #1f2937;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 9999;
            max-width: 90%;
            text-align: center;
        }
        .toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 0.5rem;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .hidden { display: none !important; }
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .item-row:hover .delete-btn { opacity: 1; }
        @media (hover: none) {
            .delete-btn { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div id="toastContainer"></div>

    <div class="min-h-screen pb-8">
        <header class="bg-white/95 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-200/80">
            <div class="max-w-lg mx-auto px-4 py-3 flex items-center">
                <button id="backBtn" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition" data-testid="button-back">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/>
                    </svg>
                </button>
                <h1 class="flex-1 text-center text-lg font-bold text-gray-900" style="font-family: 'Pretendard', sans-serif;">프로필</h1>
                <div class="w-10"></div>
            </div>
        </header>

        <main class="max-w-lg mx-auto px-4 py-4">
            <section id="profileSection" class="card">
                <div id="profileLoading" class="flex items-center gap-4">
                    <div class="skeleton w-14 h-14 rounded-full"></div>
                    <div class="flex-1">
                        <div class="skeleton h-5 w-24 mb-2"></div>
                        <div class="skeleton h-4 w-32"></div>
                    </div>
                </div>
                <div id="profileContent" class="hidden">
                    <div id="guestView" class="hidden text-center py-6">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
                            </svg>
                        </div>
                        <p class="text-gray-600 mb-4">로그인하고 35 크레딧을 받으세요</p>
                        <button id="loginBtn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:from-blue-600 hover:to-blue-700 transition shadow-lg flex items-center justify-center gap-2" data-testid="button-login">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#fff" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#fff" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#fff" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#fff" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            <span>Google로 로그인</span>
                        </button>
                    </div>
                    <div id="userView" class="hidden">
                        <div class="flex items-center gap-4">
                            <img id="profileImage" src="" alt="프로필" class="w-14 h-14 rounded-full object-cover border-2 border-gray-100">
                            <div class="flex-1">
                                <p id="userName" class="font-bold text-gray-900" data-testid="text-username"></p>
                                <p id="userEmail" class="text-sm text-gray-500" data-testid="text-email"></p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-blue-600" id="creditsAmount" data-testid="text-credits">0</p>
                                <p class="text-xs text-gray-500">크레딧</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="card">
                <button id="chargeBtn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 px-4 rounded-xl hover:from-blue-600 hover:to-blue-700 transition shadow-lg" data-testid="button-charge">
                    <span id="chargeBtnText" class="text-base whitespace-nowrap">10 EUR 충전하기 (약 ₩15,000)</span>
                </button>
            </section>

            <section id="myPagesSection" class="card">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
                        </svg>
                        <h2 class="font-bold text-gray-900">내 페이지</h2>
                    </div>
                </div>
                <div id="pagesLoading" class="space-y-2">
                    <div class="skeleton h-14 w-full"></div>
                    <div class="skeleton h-14 w-full"></div>
                </div>
                <div id="pagesList" class="hidden">
                    <div id="detailPagesContainer"></div>
                    <div id="sharePagesContainer" class="mt-3"></div>
                    <p id="noPagesMsg" class="text-center text-gray-400 py-4 hidden">아직 생성한 페이지가 없습니다</p>
                </div>
            </section>

            <section id="transactionsSection" class="card">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z"/>
                    </svg>
                    <h2 class="font-bold text-gray-900">크레딧 내역</h2>
                </div>
                <div id="transactionsLoading" class="space-y-2">
                    <div class="skeleton h-12 w-full"></div>
                    <div class="skeleton h-12 w-full"></div>
                </div>
                <div id="transactionsList" class="hidden"></div>
                <p id="noTransactions" class="text-center text-gray-400 py-4 hidden">아직 내역이 없습니다</p>
            </section>

            <section id="pricingSection" class="card">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z"/>
                    </svg>
                    <h2 class="font-bold text-gray-900">요금제</h2>
                </div>
                <div class="space-y-3">
                    <div class="plan-card" data-plan="free">
                        <div class="flex items-center justify-between">
                            <div class="text-left">
                                <p class="font-bold text-gray-900">무료체험</p>
                                <p class="text-xs text-gray-500">신규 가입</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold plan-price text-blue-600">35 크레딧</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 text-left">
                            <p class="text-sm plan-benefit text-gray-600">상세페이지 10회 + 공유페이지 3회</p>
                        </div>
                    </div>
                    <div class="plan-card" data-plan="standard">
                        <div class="flex items-center justify-between">
                            <div class="text-left">
                                <p class="font-bold text-gray-900">일반</p>
                                <p class="text-xs text-gray-500">충전 고객</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold plan-price text-blue-600">140 크레딧</p>
                                <p id="standardPrice" class="text-xs text-gray-500">10 EUR</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 text-left">
                            <p class="text-sm plan-benefit text-gray-600">100 기본 + 40 보너스</p>
                        </div>
                    </div>
                    <div class="plan-card" data-plan="pro">
                        <div class="flex items-center justify-between">
                            <div class="text-left">
                                <p class="font-bold text-gray-900">프로</p>
                                <p class="text-xs text-gray-500">기업/전문가</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold plan-price text-purple-600">별도 협의</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 text-left flex items-center justify-between">
                            <p class="text-sm plan-benefit text-gray-600">대용량 크레딧 + 맞춤 기능</p>
                            <button id="contactProBtn" class="text-sm text-blue-600 font-medium hover:underline" data-testid="button-contact-pro">문의</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const toastContainer = document.getElementById('toastContainer');
        
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
        }

        async function loadProfile() {
            try {
                const response = await fetch('/api/profile', { credentials: 'include' });
                const data = await response.json();

                document.getElementById('profileLoading').classList.add('hidden');
                document.getElementById('profileContent').classList.remove('hidden');

                if (data.authenticated && data.user) {
                    document.getElementById('guestView').classList.add('hidden');
                    document.getElementById('userView').classList.remove('hidden');
                    
                    const img = document.getElementById('profileImage');
                    if (data.user.profileImageUrl) {
                        img.src = data.user.profileImageUrl;
                    } else {
                        img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%239ca3af"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>';
                    }
                    
                    document.getElementById('userName').textContent = 
                        [data.user.firstName, data.user.lastName].filter(Boolean).join(' ') || '사용자';
                    document.getElementById('userEmail').textContent = data.user.email || '';
                    document.getElementById('creditsAmount').textContent = data.credits || 0;

                    highlightCurrentPlan(data.credits || 0);
                } else {
                    document.getElementById('guestView').classList.remove('hidden');
                    document.getElementById('userView').classList.add('hidden');
                    highlightCurrentPlan(0);
                }
            } catch (error) {
                console.error('Profile load error:', error);
                showToast('프로필을 불러오는데 실패했습니다.');
            }
        }

        async function loadPages() {
            try {
                const response = await fetch('/api/profile/pages', { credentials: 'include' });
                const data = await response.json();

                document.getElementById('pagesLoading').classList.add('hidden');
                document.getElementById('pagesList').classList.remove('hidden');

                const detailContainer = document.getElementById('detailPagesContainer');
                const shareContainer = document.getElementById('sharePagesContainer');
                
                let hasContent = false;

                if (data.detailPages && data.detailPages.length > 0) {
                    hasContent = true;
                    detailContainer.innerHTML = `
                        <p class="text-xs text-gray-500 mb-2">상세페이지 (${data.detailPages.length})</p>
                        ${data.detailPages.map(page => `
                            <div class="item-row" data-id="${page.id}" data-type="detail">
                                <div class="w-10 h-10 rounded-lg bg-gray-200 mr-3 overflow-hidden flex-shrink-0">
                                    ${page.thumbnail ? `<img src="${page.thumbnail}" class="w-full h-full object-cover">` : ''}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${page.title || '제목 없음'}</p>
                                    <p class="text-xs text-gray-500">${formatDate(page.createdAt)}</p>
                                </div>
                                <button class="delete-btn p-2 text-gray-400 hover:text-red-500" onclick="deletePage('${page.id}', 'detail')">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    `;
                }

                if (data.sharePages && data.sharePages.length > 0) {
                    hasContent = true;
                    shareContainer.innerHTML = `
                        <p class="text-xs text-gray-500 mb-2">공유페이지 (${data.sharePages.length})</p>
                        ${data.sharePages.map(page => `
                            <div class="item-row" data-id="${page.id}" data-type="share">
                                <div class="w-10 h-10 rounded-lg bg-gray-200 mr-3 overflow-hidden flex-shrink-0">
                                    ${page.thumbnail ? `<img src="${page.thumbnail}" class="w-full h-full object-cover">` : `
                                        <div class="w-full h-full bg-blue-100 flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/>
                                            </svg>
                                        </div>
                                    `}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">${page.name || '공유 링크'}</p>
                                    <p class="text-xs text-gray-500">${formatDate(page.createdAt)}</p>
                                </div>
                                <button class="delete-btn p-2 text-gray-400 hover:text-red-500" onclick="deletePage('${page.id}', 'share')">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/>
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    `;
                }

                if (!hasContent) {
                    document.getElementById('noPagesMsg').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Pages load error:', error);
            }
        }

        async function deletePage(id, type) {
            if (!confirm('정말 삭제하시겠습니까?')) return;
            
            try {
                const response = await fetch(`/api/profile/pages/${type}/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    document.querySelector(`[data-id="${id}"][data-type="${type}"]`)?.remove();
                    showToast('삭제되었습니다.');
                } else {
                    showToast('삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('삭제 중 오류가 발생했습니다.');
            }
        }

        async function loadTransactions() {
            try {
                const response = await fetch('/api/profile/transactions?limit=10', { credentials: 'include' });
                const data = await response.json();

                document.getElementById('transactionsLoading').classList.add('hidden');

                if (data.transactions && data.transactions.length > 0) {
                    const list = document.getElementById('transactionsList');
                    list.classList.remove('hidden');
                    list.innerHTML = data.transactions.map(tx => `
                        <div class="transaction-row">
                            <div>
                                <p class="text-sm text-gray-900">${tx.description}</p>
                                <p class="text-xs text-gray-400">${formatDate(tx.createdAt)}</p>
                            </div>
                            <div class="text-right">
                                <span class="${tx.amount > 0 ? 'credit-plus' : 'credit-minus'}">
                                    ${tx.amount > 0 ? '+' : ''}${tx.amount}
                                </span>
                                <p class="text-xs text-gray-400">잔액 ${tx.balance}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('noTransactions').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Transactions load error:', error);
            }
        }

        async function loadPricing() {
            try {
                const response = await fetch('/api/profile/exchange-rate');
                const data = await response.json();

                if (data.krwPrice) {
                    const krwFormatted = new Intl.NumberFormat('ko-KR').format(Math.round(data.krwPrice));
                    document.getElementById('standardPrice').textContent = `10 EUR (약 ₩${krwFormatted})`;
                    document.getElementById('chargeBtnText').textContent = `10 EUR 충전하기 (약 ₩${krwFormatted})`;
                }
            } catch (error) {
                console.error('Pricing load error:', error);
            }
        }

        function highlightCurrentPlan(credits) {
            const cards = document.querySelectorAll('.plan-card');
            cards.forEach(card => card.classList.remove('active'));

            if (credits >= 140) {
                document.querySelector('[data-plan="standard"]')?.classList.add('active');
            } else if (credits > 0) {
                document.querySelector('[data-plan="free"]')?.classList.add('active');
            }
        }

        document.getElementById('backBtn').addEventListener('click', () => {
            if (window.opener && !window.opener.closed) {
                window.close();
            } else {
                window.location.href = '/#archive';
            }
        });

        document.getElementById('loginBtn')?.addEventListener('click', () => {
            window.location.href = '/api/auth/google';
        });

        document.getElementById('chargeBtn').addEventListener('click', async () => {
            const btn = document.getElementById('chargeBtn');
            btn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">처리 중...</span>';

            try {
                const response = await fetch('/api/profile/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.error) {
                    if (response.status === 401) {
                        showToast('로그인이 필요합니다.');
                        setTimeout(() => window.location.href = '/api/auth/google', 1500);
                    } else {
                        showToast(data.error);
                    }
                } else if (data.url) {
                    window.location.href = data.url;
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showToast('결제 처리 중 오류가 발생했습니다.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });

        document.getElementById('contactProBtn')?.addEventListener('click', () => {
            window.location.href = 'mailto:dbstour1@gmail.com?subject=[손안에 가이드] 프로플랜 문의';
        });

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment') === 'success') {
            showToast('결제가 완료되었습니다! 크레딧이 충전되었습니다.');
            window.history.replaceState({}, document.title, '/profile.html');
        } else if (urlParams.get('payment') === 'cancel') {
            showToast('결제가 취소되었습니다.');
            window.history.replaceState({}, document.title, '/profile.html');
        }

        loadProfile();
        loadPages();
        loadTransactions();
        loadPricing();
    </script>
</body>
</html>
