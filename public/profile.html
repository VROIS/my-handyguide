<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>í”„ë¡œí•„ - ë‚´ì†ê°€ì´ë“œ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234285F4'><path d='M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z'/></svg>">
    <meta name="theme-color" content="#4285F4"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://hangeul.pstatic.net">
    <link rel="stylesheet" href="https://hangeul.pstatic.net/maruburi/maruburi.css">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --gemini-blue: #4285F4;
            --gemini-blue-light: rgba(66, 133, 244, 0.1);
        }
        html, body { 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent; 
            min-height: 100vh;
            background-color: #FFFEFA;
            font-family: 'MaruBuri', 'Pretendard', sans-serif;
        }
        .btn-primary {
            background-color: var(--gemini-blue);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #3367d6;
        }
        .btn-primary:active {
            transform: scale(0.98);
        }
        .btn-secondary {
            background-color: var(--gemini-blue-light);
            color: var(--gemini-blue);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background-color: rgba(66, 133, 244, 0.2);
        }
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        .plan-card {
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            transition: all 0.2s;
        }
        .plan-card.active {
            border-color: var(--gemini-blue);
            background-color: var(--gemini-blue-light);
        }
        .plan-card:hover {
            border-color: var(--gemini-blue);
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .credit-positive {
            color: #10b981;
            font-weight: 600;
        }
        .credit-negative {
            color: #ef4444;
            font-weight: 600;
        }
        .toast-notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: #1f2937;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 9999;
            max-width: 90%;
            text-align: center;
        }
        .toast-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 0.5rem;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="toastContainer"></div>

    <div class="min-h-screen pb-24">
        <header class="bg-white sticky top-0 z-50 border-b border-gray-100">
            <div class="max-w-lg mx-auto px-4 py-3 flex items-center justify-between">
                <button id="backBtn" class="p-2 -ml-2 rounded-full hover:bg-gray-100 transition" data-testid="button-back">
                    <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <h1 class="text-lg font-bold text-gray-900" style="font-family: 'Pretendard', sans-serif;">í”„ë¡œí•„</h1>
                <div class="w-10"></div>
            </div>
        </header>

        <main class="max-w-lg mx-auto px-4 py-4">
            <section id="profileSection" class="card">
                <div id="profileLoading" class="flex items-center gap-4">
                    <div class="skeleton w-16 h-16 rounded-full"></div>
                    <div class="flex-1">
                        <div class="skeleton h-5 w-24 mb-2"></div>
                        <div class="skeleton h-4 w-32"></div>
                    </div>
                </div>
                <div id="profileContent" class="hidden">
                    <div id="guestView" class="hidden text-center py-4">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gray-100 rounded-full flex items-center justify-center">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                        </div>
                        <p class="text-gray-600 mb-4">ë¡œê·¸ì¸í•˜ê³  35 í¬ë ˆë”§ì„ ë°›ìœ¼ì„¸ìš”!</p>
                        <button id="loginBtn" class="btn-primary" data-testid="button-login">ë¡œê·¸ì¸</button>
                    </div>
                    <div id="userView" class="hidden">
                        <div class="flex items-center gap-4">
                            <img id="profileImage" src="" alt="í”„ë¡œí•„" class="w-16 h-16 rounded-full object-cover border-2 border-gray-100">
                            <div>
                                <p id="userName" class="font-bold text-gray-900 text-lg" data-testid="text-username"></p>
                                <p id="userEmail" class="text-sm text-gray-500" data-testid="text-email"></p>
                                <p id="userProvider" class="text-xs text-gray-400 mt-1"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="creditsSection" class="card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="font-bold text-gray-900">ğŸ’° ë‚´ í¬ë ˆë”§</h2>
                    <div id="creditsLoading" class="skeleton h-8 w-20"></div>
                    <div id="creditsDisplay" class="hidden flex items-center gap-2">
                        <span id="creditsAmount" class="text-2xl font-bold text-blue-600" data-testid="text-credits">0</span>
                        <span class="text-gray-500">í¬ë ˆë”§</span>
                    </div>
                </div>
                <button id="chargeBtn" class="btn-primary w-full" data-testid="button-charge">
                    <span id="chargeBtnText">ì¶©ì „í•˜ê¸°</span>
                    <span id="chargeBtnPrice" class="ml-2 opacity-75"></span>
                </button>
            </section>

            <section id="statsSection" class="card">
                <h2 class="font-bold text-gray-900 mb-3">ğŸ“Š ì´ìš© í˜„í™©</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-blue-600" id="statDetailPages" data-testid="text-detail-count">0</p>
                        <p class="text-sm text-gray-600">ìƒì„¸í˜ì´ì§€</p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-green-600" id="statSharePages" data-testid="text-share-count">0</p>
                        <p class="text-sm text-gray-600">ê³µìœ í˜ì´ì§€</p>
                    </div>
                </div>
            </section>

            <section id="referralSection" class="card hidden">
                <h2 class="font-bold text-gray-900 mb-3">ğŸ ì¹œêµ¬ ì´ˆëŒ€</h2>
                <p class="text-sm text-gray-600 mb-3">ì¹œêµ¬ê°€ ê°€ì…í•˜ë©´ 10 í¬ë ˆë”§ì„ ë°›ì•„ìš”!</p>
                <div class="flex items-center gap-2">
                    <div class="flex-1 bg-gray-100 rounded-lg px-4 py-3 font-mono text-center">
                        <span id="referralCode" data-testid="text-referral-code"></span>
                    </div>
                    <button id="copyReferralBtn" class="btn-secondary px-4" data-testid="button-copy-referral">ë³µì‚¬</button>
                </div>
            </section>

            <section id="transactionsSection" class="card">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="font-bold text-gray-900">ğŸ“œ í¬ë ˆë”§ ë‚´ì—­</h2>
                    <button id="viewAllTransactionsBtn" class="text-sm text-blue-600 hover:underline hidden" data-testid="button-view-all">ë”ë³´ê¸°</button>
                </div>
                <div id="transactionsLoading" class="space-y-3">
                    <div class="skeleton h-12 w-full"></div>
                    <div class="skeleton h-12 w-full"></div>
                    <div class="skeleton h-12 w-full"></div>
                </div>
                <div id="transactionsList" class="hidden">
                    <p id="noTransactions" class="text-center text-gray-400 py-4 hidden">ì•„ì§ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            </section>

            <section id="pricingSection" class="card">
                <h2 class="font-bold text-gray-900 mb-4">ğŸ’³ ìš”ê¸ˆì œ</h2>
                <div class="grid grid-cols-2 gap-3" id="pricingGrid">
                    <div class="plan-card" data-plan="test">
                        <p class="font-bold text-gray-900">í…ŒìŠ¤íŠ¸</p>
                        <p class="text-xs text-gray-500 mb-2">ë¹„íšŒì›</p>
                        <p class="text-lg font-bold text-gray-700">ë¬´ë£Œ</p>
                        <p class="text-xs text-gray-500 mt-1">ìƒì„¸ 3íšŒ + ê³µìœ  2íšŒ</p>
                    </div>
                    <div class="plan-card" data-plan="free">
                        <p class="font-bold text-gray-900">ë¬´ë£Œì²´í—˜</p>
                        <p class="text-xs text-gray-500 mb-2">ì‹ ê·œ íšŒì›</p>
                        <p class="text-lg font-bold text-blue-600">35 í¬ë ˆë”§</p>
                        <p class="text-xs text-gray-500 mt-1">ê°€ì… ì¦‰ì‹œ ì§€ê¸‰</p>
                    </div>
                    <div class="plan-card" data-plan="standard">
                        <p class="font-bold text-gray-900">ì¼ë°˜</p>
                        <p class="text-xs text-gray-500 mb-2">ì¶©ì „ ê³ ê°</p>
                        <p class="text-lg font-bold text-blue-600">140 í¬ë ˆë”§</p>
                        <p id="standardPrice" class="text-xs text-gray-500 mt-1">~â‚©15,000</p>
                    </div>
                    <div class="plan-card" data-plan="pro">
                        <p class="font-bold text-gray-900">í”„ë¡œ</p>
                        <p class="text-xs text-gray-500 mb-2">ê¸°ì—…/ì „ë¬¸ê°€</p>
                        <p class="text-lg font-bold text-purple-600">ë³„ë„ í˜‘ì˜</p>
                        <button id="contactProBtn" class="text-xs text-blue-600 mt-1 hover:underline" data-testid="button-contact-pro">ë¬¸ì˜í•˜ê¸°</button>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600"><strong>í¬ë ˆë”§ ì‚¬ìš©ëŸ‰:</strong></p>
                    <ul class="text-sm text-gray-500 mt-1 space-y-1">
                        <li>â€¢ ìƒì„¸í˜ì´ì§€ ìƒì„±: 2 í¬ë ˆë”§</li>
                        <li>â€¢ ê³µìœ í˜ì´ì§€ ìƒì„±: 5 í¬ë ˆë”§</li>
                    </ul>
                </div>
            </section>

            <section id="cashbackSection" class="card hidden">
                <h2 class="font-bold text-gray-900 mb-3">ğŸ’µ ìºì‹œë°±</h2>
                <p class="text-sm text-gray-600 mb-3">1,000 í¬ë ˆë”§ ì´ìƒ ë³´ìœ  ì‹œ ìºì‹œë°± ì‹ ì²­ ê°€ëŠ¥!</p>
                <p class="text-sm text-gray-500 mb-3">200 í¬ë ˆë”§ = 20 EUR (ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì§€ê¸‰)</p>
                <button id="cashbackBtn" class="btn-secondary w-full" data-testid="button-cashback">ìºì‹œë°± ì‹ ì²­</button>
            </section>
        </main>
    </div>

    <script>
        const toastContainer = document.getElementById('toastContainer');
        
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            toastContainer.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function loadProfile() {
            try {
                const response = await fetch('/api/profile', { credentials: 'include' });
                const data = await response.json();

                document.getElementById('profileLoading').classList.add('hidden');
                document.getElementById('profileContent').classList.remove('hidden');

                if (data.authenticated && data.user) {
                    document.getElementById('guestView').classList.add('hidden');
                    document.getElementById('userView').classList.remove('hidden');
                    
                    const img = document.getElementById('profileImage');
                    if (data.user.profileImageUrl) {
                        img.src = data.user.profileImageUrl;
                    } else {
                        img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%239ca3af"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>';
                    }
                    
                    document.getElementById('userName').textContent = 
                        [data.user.firstName, data.user.lastName].filter(Boolean).join(' ') || 'ì‚¬ìš©ì';
                    document.getElementById('userEmail').textContent = data.user.email || '';
                    
                    const providers = { 'google': 'Google ë¡œê·¸ì¸', 'kakao': 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸', 'replit': 'Replit ë¡œê·¸ì¸' };
                    document.getElementById('userProvider').textContent = providers[data.user.provider] || '';

                    if (data.user.referralCode) {
                        document.getElementById('referralSection').classList.remove('hidden');
                        document.getElementById('referralCode').textContent = data.user.referralCode;
                    }

                    if (data.canCashback) {
                        document.getElementById('cashbackSection').classList.remove('hidden');
                    }

                    document.getElementById('creditsAmount').textContent = data.credits;
                    document.getElementById('statDetailPages').textContent = data.stats?.detailPages || 0;
                    document.getElementById('statSharePages').textContent = data.stats?.sharePages || 0;

                    highlightCurrentPlan(data.credits);
                } else {
                    document.getElementById('guestView').classList.remove('hidden');
                    document.getElementById('userView').classList.add('hidden');
                    document.getElementById('creditsAmount').textContent = '0';
                    highlightCurrentPlan(0);
                }

                document.getElementById('creditsLoading').classList.add('hidden');
                document.getElementById('creditsDisplay').classList.remove('hidden');

            } catch (error) {
                console.error('Profile load error:', error);
                showToast('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadTransactions() {
            try {
                const response = await fetch('/api/profile/transactions?limit=5', { credentials: 'include' });
                const data = await response.json();

                document.getElementById('transactionsLoading').classList.add('hidden');
                document.getElementById('transactionsList').classList.remove('hidden');

                if (data.transactions && data.transactions.length > 0) {
                    const list = document.getElementById('transactionsList');
                    list.innerHTML = data.transactions.map(tx => `
                        <div class="transaction-item">
                            <div>
                                <p class="text-sm text-gray-900">${tx.description}</p>
                                <p class="text-xs text-gray-400">${formatDate(tx.createdAt)}</p>
                            </div>
                            <span class="${tx.amount > 0 ? 'credit-positive' : 'credit-negative'}">
                                ${tx.amount > 0 ? '+' : ''}${tx.amount}
                            </span>
                        </div>
                    `).join('');

                    if (data.transactions.length >= 5) {
                        document.getElementById('viewAllTransactionsBtn').classList.remove('hidden');
                    }
                } else {
                    document.getElementById('noTransactions').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Transactions load error:', error);
            }
        }

        async function loadPricing() {
            try {
                const response = await fetch('/api/profile/exchange-rate');
                const data = await response.json();

                if (data.formattedPrice) {
                    document.getElementById('standardPrice').textContent = data.formattedPrice;
                    document.getElementById('chargeBtnPrice').textContent = `(${data.formattedPrice})`;
                }
            } catch (error) {
                console.error('Pricing load error:', error);
            }
        }

        function highlightCurrentPlan(credits) {
            const cards = document.querySelectorAll('.plan-card');
            cards.forEach(card => card.classList.remove('active'));

            if (credits === 0) {
                document.querySelector('[data-plan="test"]')?.classList.add('active');
            } else if (credits > 0 && credits <= 35) {
                document.querySelector('[data-plan="free"]')?.classList.add('active');
            } else {
                document.querySelector('[data-plan="standard"]')?.classList.add('active');
            }
        }

        document.getElementById('backBtn').addEventListener('click', () => {
            if (window.opener && !window.opener.closed) {
                window.close();
            } else {
                window.location.href = '/#archive';
            }
        });

        document.getElementById('loginBtn')?.addEventListener('click', () => {
            window.location.href = '/api/auth/google';
        });

        document.getElementById('chargeBtn').addEventListener('click', async () => {
            const btn = document.getElementById('chargeBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">ì²˜ë¦¬ ì¤‘...</span>';

            try {
                const response = await fetch('/api/profile/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.error) {
                    if (response.status === 401) {
                        showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        setTimeout(() => {
                            window.location.href = '/api/auth/google';
                        }, 1500);
                    } else {
                        showToast(data.error);
                    }
                } else if (data.url) {
                    window.location.href = data.url;
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showToast('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span id="chargeBtnText">ì¶©ì „í•˜ê¸°</span><span id="chargeBtnPrice" class="ml-2 opacity-75"></span>';
                loadPricing();
            }
        });

        document.getElementById('copyReferralBtn')?.addEventListener('click', () => {
            const code = document.getElementById('referralCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('ì¶”ì²œ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(() => {
                showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        });

        document.getElementById('contactProBtn')?.addEventListener('click', () => {
            window.location.href = 'mailto:dbstour1@gmail.com?subject=[ë‚´ì†ê°€ì´ë“œ] í”„ë¡œí”Œëœ ë¬¸ì˜';
        });

        document.getElementById('cashbackBtn')?.addEventListener('click', () => {
            showToast('ìºì‹œë°± ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì§€ê¸‰ë©ë‹ˆë‹¤.');
        });

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment') === 'success') {
            showToast('ğŸ‰ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í¬ë ˆë”§ì´ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.history.replaceState({}, document.title, '/profile.html');
        } else if (urlParams.get('payment') === 'cancel') {
            showToast('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.history.replaceState({}, document.title, '/profile.html');
        }

        loadProfile();
        loadTransactions();
        loadPricing();
    </script>
</body>
</html>
