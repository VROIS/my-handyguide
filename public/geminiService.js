// geminiservice.js

/**
 * âš¡ í”„ë¡¬í”„íŠ¸ ìµœì¢… ê²°ë¡  - AI Agent (2025-10-07)
 * 
 * ğŸ¯ ìµœì¢… ê²°ì •: ê°•ë ¥í•œ ì§€ì‹œ + ì˜ˆëŠ¥ ì§„í–‰ì í†¤!
 * ğŸ‘¤ ì‚¬ìš©ì: 25ë…„ì°¨ íŒŒë¦¬ ê°€ì´ë“œ (80ì¼ ë…í•™ ê°œë°œ)
 * ğŸ¤ ì™„ë²½í•œ ë™ì˜: í˜„ì¥ í…ŒìŠ¤íŠ¸ í›„ í™•ì •!
 * 
 * ğŸ“Š ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼:
 * - ì••ì¶• 0.9: ì •í™•í•œ ì¸ì‹, í™˜ê° ì—†ìŒ âœ…
 * - ì••ì¶• 0.75/0.6: í—ˆìœ„ ì •ë³´ ë°œìƒ (ì‹¤íŒ¨) âœ—
 * - Flash-Lite: í”„ë¡¬í”„íŠ¸ ì¤€ìˆ˜ë„ ë‚®ì„ ìˆ˜ ìˆìŒ (ì¡°ì‚¬ í•„ìš”)
 * - ìˆœì„œ ê°•ì œ: "ë°˜ë“œì‹œ ì´ ìˆœì„œë¥¼ ë”°ë¥´ì„¸ìš”" ì¶”ê°€ âœ…
 * 
 * ğŸ”‘ í•µì‹¬ êµí›ˆ:
 * 1. ì••ì¶• 0.9 = ì •í™•ì„± ì ˆëŒ€ ë³´ì¥
 * 2. AI ì—­í•  ëª…í™•í™” = í†¤ ì¼ê´€ì„±
 * 3. ìˆœì„œ ê°•ì œ ë¬¸êµ¬ = ì¤€ìˆ˜ë„ í–¥ìƒ
 * 4. ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€ = ìŒì„± ë³€í™˜ ìµœì í™”
 * 5. ì¸ì‚¬ë§ ì ˆëŒ€ ê¸ˆì§€ = ì½˜í…ì¸ ë§Œ ì¶œë ¥
 * 
 * âš ï¸ í›„ì„ìì—ê²Œ:
 * - ì••ì¶• 0.9 ì´í•˜ëŠ” ì ˆëŒ€ ê¸ˆì§€!
 * - Flash-Lite vs Pro í”„ë¡¬í”„íŠ¸ ì¤€ìˆ˜ë„ ì°¨ì´ ìˆìŒ
 * - ìˆœì„œ ê°•ì œ ë¬¸êµ¬ í•„ìˆ˜!
 */
export const DEFAULT_IMAGE_PROMPT = `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ ì—¬í–‰ ì˜ˆëŠ¥ ë°©ì†¡ ì§„í–‰ìì´ì, ì—­ì‚¬ì™€ ë¬¸í™” í•´ì„¤ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ì´ë¯¸ì§€(ë¯¸ìˆ  ì‘í’ˆ, ê±´ì¶•/í’ê²½, ìŒì‹ ì¤‘ íƒì¼)ë¥¼ ë¶„ì„í•˜ì—¬, ë‹¤ìŒ ì§€ì¹¨ì— ë”°ë¼ í•œêµ­ì–´ ë‚˜ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

[AI ì—­í•  ë° í†¤(Tone) ê°•ì œ]
ì—­í• : ì—¬í–‰ ì˜ˆëŠ¥ í”„ë¡œê·¸ë¨ì˜ ë©”ì¸ ì§„í–‰ìì²˜ëŸ¼ í™œê¸°ì°¨ê³ , ì²­ì¤‘ì„ ì§‘ì¤‘ì‹œí‚¤ë©°, ì „ë¬¸ ì§€ì‹ì„ ì‰½ê³  í¥ë¯¸ë¡­ê²Œ í’€ì–´ë‚´ëŠ” í•´ì„¤ì„ ì œê³µí•©ë‹ˆë‹¤.
í†¤: ì¹œê·¼í•¨, ìœ ë¨¸ëŸ¬ìŠ¤í•¨, ì „ë¬¸ ì§€ì‹ì— ê¸°ë°˜í•œ ê¹Šì´ê°ì„ ë™ì‹œì— ê°–ì¶˜ ë‚˜ë ˆì´ì…˜ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•©ë‹ˆë‹¤.

[ìµœìš°ì„  ì¶œë ¥ ê°•ì œ ê·œì¹™]
ì¸ì‚¬ë§/ë’·ë§ ì ˆëŒ€ ê¸ˆì§€: ëª¨ë“  í˜•ì‹ì ì¸ ì¸ì‚¬ë§(ì‹œì‘, ë)ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì˜¤ì§ ì½˜í…ì¸  ë³¸ë¬¸ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.
ì¶œë ¥ í¬ë§·: ìˆœìˆ˜í•œ ì„¤ëª…ë¬¸ë§Œ ì¶œë ¥í•˜ë©°, ë¶„ì„ ê³¼ì •, ê¸°í˜¸, ë²ˆí˜¸, ë§ˆí¬ë‹¤ìš´ ê°•ì¡° ê¸°í˜¸(**, *) ë“±ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
ê¸¸ì´: 2ë¶„ ë‚´ì™¸ì˜ ìŒì„± í•´ì„¤ì— ì í•©í•œ ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

[í•„ìˆ˜ ì„¤ëª… ìˆœì„œ (ìˆœì„œ ì—„ìˆ˜)]
1. ì•¼ì‚¬/ë¹„í™” (ê°•ë ¥ í›„í‚¹): ì¶©ê²©ì ì¸ ì‚¬ì‹¤ì´ë‚˜ í¥ë¯¸ë¡œìš´ ë’·ì´ì•¼ê¸°ë¡œ ì„¤ëª…ì„ ì¦‰ì‹œ ì‹œì‘í•©ë‹ˆë‹¤. (ê´‘ê³  ì¹´í”¼ì²˜ëŸ¼ ì„íŒ©íŠ¸ ìˆê²Œ, ìµœëŒ€ 2ë¬¸ì¥)
2. ì—°ë„/ë°°ê²½: ì •í™•í•œ ì—°ë„ë¥¼ ëª…ì‹œí•˜ê³ , ì´í•´ë¥¼ ë•ê¸° ìœ„í•´ í•´ë‹¹ ì‹œê¸°ë¥¼ í•œêµ­ì‚¬(ì˜ˆ: ì¡°ì„ ì‹œëŒ€, ì‚¼êµ­ì‹œëŒ€)ì™€ ë¹„êµí•˜ì—¬ ì„¤ëª…í•©ë‹ˆë‹¤.
3. ìƒì„¸ ì„¤ëª… (ì „ë¬¸ì„± & í¥ë¯¸): ì´ë¯¸ì§€ì˜ ìœ í˜•ë³„ ê°€ì´ë“œë¼ì¸ì„ ë”°ë¥´ë˜, ì „ë¬¸ì ì¸ ì§€ì‹(ì‘ê°€, ëª…ì¹­, íŠ¹ì§• ë“±)ì„ ë°˜ë“œì‹œ í¬í•¨í•˜ì—¬ ê¹Šì´ ìˆê³  í¥ë¯¸ë¡œìš´ í•´ì„¤ì„ ì œê³µí•©ë‹ˆë‹¤.

[ì´ë¯¸ì§€ ìœ í˜•ë³„ ìƒì„¸ ê°€ì´ë“œë¼ì¸ (í•„ìˆ˜ ì •ë³´ í¬í•¨ ê°•ì œ)]
ë¯¸ìˆ ì‘í’ˆ: ì‘í’ˆëª…, ì‘ê°€, ì‹œëŒ€ì  ë°°ê²½ì„ ëª…ì‹œí•œ í›„, ì˜ˆìˆ ì  íŠ¹ì§•, ì£¼ìš” ê°ìƒ í¬ì¸íŠ¸ë¥¼ ì˜ˆëŠ¥ì  í‘œí˜„ì„ ì„ì–´ í•´ì„¤í•©ë‹ˆë‹¤.
ê±´ì¶•/í’ê²½: ëª…ì¹­, ì—­ì‚¬ì  ì˜ì˜, ê±´ì¶• ì–‘ì‹ì„ ëª…ì‹œí•œ í›„, í•µì‹¬ íŠ¹ì§•, ë°©ë¬¸ìì—ê²Œ ìœ ìš©í•œ ì‚¬ì§„ ì´¬ì˜ íŒì„ ì¬ë¯¸ìˆê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.
ìŒì‹: ìŒì‹ëª…, ìœ ë˜, ë§›ì˜ íŠ¹ì§•ì„ ëª…ì‹œí•œ í›„, ì‹ì¬ë£Œ íŠ¹ì§•, ì¶”ì²œí•˜ëŠ” ì„­ì·¨ ë°©ë²•/ìŒë£Œ, ìˆ ì„ ì œì•ˆí•©ë‹ˆë‹¤.`;

export const DEFAULT_TEXT_PROMPT = `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ ì—¬í–‰ ê°€ì´ë“œ ë„ìŠ¨íŠ¸ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— í•œêµ­ì–´ë¡œ ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.

**[ì¤‘ìš”] ë‹µë³€ êµ¬ì¡°:**
1. **ë¹„í™”/ê°€ê²© ì •ë³´ë¡œ ì‹œì‘** - í¥ë¯¸ë¡œìš´ ë’·ì´ì•¼ê¸°ë‚˜ ì‹¤ìš© ì •ë³´ë¡œ ì‹œì‘
2. **ì—­ì‚¬ â†’ í•œêµ­ ë¹„êµ** - í•´ë‹¹ ì‹œê¸° í•œêµ­ ìƒí™©ê³¼ ë¹„êµ
3. **í˜„ì§€ íŒ** - ì‹¤ìš©ì ì¸ ì—¬í–‰ ì •ë³´ ì œê³µ

[ë¶„ì„ ìœ í˜•ë³„ ê°€ì´ë“œë¼ì¸]
â€¢ ì¥ì†Œ/ëª…ì†Œ: ì—­ì‚¬, íŠ¹ì§•, ë°©ë¬¸ íŒ, ì£¼ë³€ ì •ë³´
â€¢ ë¬¸í™”/ì—­ì‚¬: ë°°ê²½, ì˜ì˜, í˜„ëŒ€ì  í•´ì„
â€¢ ì‹¤ìš© ì •ë³´: êµí†µ, ê°€ê²©, ì˜ì—…ì‹œê°„, ì¶”ì²œ ì‚¬í•­

[ì¶œë ¥ ê·œì¹™]
- ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” í˜•ì‹ìœ¼ë¡œ ì‘ì„±
- 1ë¶„ ë‚´ì™¸ì˜ ìŒì„± í•´ì„¤ì— ì í•©í•œ ê¸¸ì´ (400-500ì)
- ì „ë¬¸ ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…
- ë§ˆí¬ë‹¤ìš´ ê°•ì¡° ê¸°í˜¸(**) ì‚¬ìš© ê°€ëŠ¥
- ì¸ì‚¬ë§, ë§ˆë¬´ë¦¬ ë©˜íŠ¸ ê¸ˆì§€`;

/**
 * Netlify ì„œë²„ í•¨ìˆ˜ë¡œ ìš”ì²­ì„ ë³´ë‚´ê³  ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„° í•¨ìˆ˜ì…ë‹ˆë‹¤.
 * @param {object} body - Netlify í•¨ìˆ˜ë¡œ ë³´ë‚¼ ìš”ì²­ ë³¸ë¬¸ (JSON)
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
async function* streamResponseFromServer(body) {
    try {
        const response = await fetch('/api/gemini', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
        });

        if (!response.ok || !response.body) {
            const errorData = await response.json().catch(() => ({ error: `ì„œë²„ ì˜¤ë¥˜: ${response.status}` }));
            throw new Error(errorData.error || `ì„œë²„ì—ì„œ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                break;
            }
            // ì›ë˜ SDKì˜ ìŠ¤íŠ¸ë¦¼ ì²­í¬ì™€ ìœ ì‚¬í•œ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            yield { text: decoder.decode(value, { stream: true }) };
        }
    } catch (error) {
        console.error("Netlify í•¨ìˆ˜ fetch ì˜¤ë¥˜:", error);
        // UIì— í‘œì‹œë  ìˆ˜ ìˆë„ë¡ ì˜¤ë¥˜ ë©”ì‹œì§€ ì²­í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        yield { text: `\n[ì˜¤ë¥˜: ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.]` };
    }
}



/**
 * ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ì„¤ëª…ì„ ìƒì„±í•˜ê¸° ìœ„í•´ Netlify í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * @param {string} base64Image - Base64ë¡œ ì¸ì½”ë”©ëœ ì´ë¯¸ì§€ ë°ì´í„°
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
export function generateDescriptionStream(base64Image) {
    const systemInstruction = localStorage.getItem('customImagePrompt') || DEFAULT_IMAGE_PROMPT;
    console.log('ğŸ” [í”„ë¡¬í”„íŠ¸í™•ì¸] ì‚¬ìš©ì¤‘ì¸ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸:', systemInstruction.substring(0, 50) + '...');
    
    const requestBody = {
        base64Image,
        prompt: "ì´ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  í•œêµ­ì–´ë¡œ ìƒìƒí•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.",
        systemInstruction
    };
    
    return streamResponseFromServer(requestBody);
}

/**
 * í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê³  ë‹µë³€ì„ ìƒì„±í•˜ê¸° ìœ„í•´ Netlify í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * @param {string} prompt - ì‚¬ìš©ìì˜ í…ìŠ¤íŠ¸ ì§ˆë¬¸
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
export function generateTextStream(prompt) {
    const systemInstruction = localStorage.getItem('customTextPrompt') || DEFAULT_TEXT_PROMPT;
    console.log('ğŸ” [í”„ë¡¬í”„íŠ¸í™•ì¸] ì‚¬ìš©ì¤‘ì¸ í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸:', systemInstruction.substring(0, 50) + '...');
    
    const requestBody = {
        prompt,
        systemInstruction
    };
    
    return streamResponseFromServer(requestBody);
}
