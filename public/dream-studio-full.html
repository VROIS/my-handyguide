<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¬ ë“œë¦¼ ìŠ¤íŠœë””ì˜¤ | ê³µìœ ì˜ìƒ ìƒì„±ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 430px;
            margin: 0 auto;
            background: #0f0f23;
            min-height: 100vh;
            padding-bottom: 100px;
        }
        
        .header {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            text-align: center;
        }
        
        .tabs {
            display: flex;
            background: #1a1a2e;
            border-bottom: 1px solid #333;
        }
        
        .tab {
            flex: 1;
            padding: 14px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }
        
        .tab-content { display: none; padding: 16px; }
        .tab-content.active { display: block; }
        
        /* ì…ë ¥ ì˜ì—­ */
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #aaa;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 14px;
        }
        
        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* ì´ë¯¸ì§€ ì—…ë¡œë“œ */
        .upload-zone {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 16px;
        }
        
        .upload-zone:hover { border-color: #667eea; }
        .upload-zone.has-image { padding: 0; border: none; }
        .upload-zone img { width: 100%; border-radius: 12px; }
        
        /* ìŠ¬ë¡¯ ê·¸ë¦¬ë“œ (6ê°œ) */
        .slot-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 16px 0;
        }
        
        .slot {
            aspect-ratio: 3/4;
            background: #1a1a2e;
            border: 2px dashed #333;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .slot.filled {
            border: none;
        }
        
        .slot img, .slot video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .slot-number {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .slot-status {
            position: absolute;
            bottom: 8px;
            right: 8px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
        }
        
        .slot-status.ready { background: #22c55e; }
        .slot-status.processing { background: #f59e0b; }
        .slot-status.error { background: #ef4444; }
        
        /* ë²„íŠ¼ */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #2a2a4a;
            color: #ccc;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* í”„ë¡œì„¸ìŠ¤ ìƒíƒœ */
        .process-status {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .process-step {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        
        .process-step:last-child { border-bottom: none; }
        
        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 14px;
        }
        
        .step-icon.pending { background: #333; }
        .step-icon.processing { background: #f59e0b; animation: pulse 1s infinite; }
        .step-icon.done { background: #22c55e; }
        .step-icon.error { background: #ef4444; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° */
        .result-preview {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin: 16px 0;
        }
        
        .result-preview video {
            width: 100%;
            aspect-ratio: 9/16;
        }
        
        /* ì„¤ì • íŒ¨ë„ */
        .settings-panel {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .settings-panel h3 {
            margin-bottom: 12px;
            font-size: 14px;
            color: #aaa;
        }
        
        /* í”„ë¡¬í”„íŠ¸ ë³µì‚¬ ì˜ì—­ */
        .prompt-box {
            background: #0d0d1a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            color: #ccc;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 8px;
        }
        
        .copy-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* ê³µìœ ì˜ìƒ ê°¤ëŸ¬ë¦¬ (ê³µìœ í˜ì´ì§€ ìŠ¤íƒ€ì¼) */
        .share-gallery {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 16px;
        }
        
        .gallery-item {
            aspect-ratio: 3/4;
            background: #1a1a2e;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        
        .gallery-item video, .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-item .play-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gallery-item .play-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ìƒì„¸ ë·° ëª¨ë‹¬ */
        .detail-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000;
            z-index: 1000;
        }
        
        .detail-modal.active { display: flex; flex-direction: column; }
        
        .detail-modal video {
            flex: 1;
            width: 100%;
            object-fit: contain;
        }
        
        .detail-modal .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* API í‚¤ ì…ë ¥ */
        .api-key-input {
            display: flex;
            gap: 8px;
        }
        
        .api-key-input input {
            flex: 1;
            font-family: monospace;
        }
        
        /* ì•Œë¦¼ */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 2000;
            display: none;
        }
        
        .toast.show { display: block; animation: fadeInUp 0.3s; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1 class="text-xl font-bold">ğŸ¬ ë“œë¦¼ ìŠ¤íŠœë””ì˜¤</h1>
            <p class="text-sm opacity-80 mt-1">20ì´ˆ ê³µìœ ì˜ìƒ ìƒì„±ê¸°</p>
        </div>
        
        <!-- íƒ­ -->
        <div class="tabs">
            <div class="tab active" data-tab="create" onclick="switchTab('create')">ğŸ“· ìƒì„±</div>
            <div class="tab" data-tab="gallery" onclick="switchTab('gallery')">ğŸ¬ ê°¤ëŸ¬ë¦¬</div>
            <div class="tab" data-tab="settings" onclick="switchTab('settings')">âš™ï¸ ì„¤ì •</div>
        </div>
        
        <!-- ìƒì„± íƒ­ -->
        <div id="tab-create" class="tab-content active">
            <!-- ë‚´ ê°€ì´ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ -->
            <button class="btn btn-secondary" onclick="openGuideSelector()" style="margin-bottom: 12px;">
                ğŸ“‚ ë‚´ ê°€ì´ë“œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ë¹„ìš© ì ˆê°!)
            </button>
            
            <!-- ìŠ¬ë¡¯ ê·¸ë¦¬ë“œ (6ê°œ) -->
            <h3 class="text-sm text-gray-400 mb-2">ğŸ“‚ ì´ë¯¸ì§€ ìŠ¬ë¡¯ (ìµœëŒ€ 6ê°œ)</h3>
            <div class="slot-grid" id="slotGrid">
                <!-- JSë¡œ ìƒì„± -->
            </div>
            
            <!-- í˜„ì¬ ì„ íƒëœ ìŠ¬ë¡¯ í¸ì§‘ -->
            <div id="slotEditor" style="display:none;">
                <div class="settings-panel">
                    <h3>ğŸ–¼ï¸ ìŠ¬ë¡¯ #<span id="currentSlotNum">1</span> í¸ì§‘</h3>
                    
                    <!-- ì†ŒìŠ¤ í‘œì‹œ -->
                    <div id="sourceIndicator" class="text-xs text-green-400 mb-2" style="display:none;">
                        âœ… DBì—ì„œ ë¶ˆëŸ¬ì˜´ (ì´ë¯¸ì§€ ë¶„ì„ ë¶ˆí•„ìš”)
                    </div>
                    
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('imageInput').click()">
                        <input type="file" id="imageInput" accept="image/*" style="display:none">
                        <div id="uploadPlaceholder">
                            <div class="text-3xl mb-2">ğŸ“·</div>
                            <p class="text-gray-400 text-sm">ì´ë¯¸ì§€ ì—…ë¡œë“œ ë˜ëŠ” ê°€ì´ë“œ ì„ íƒ</p>
                        </div>
                        <img id="previewImage" src="" style="display:none">
                    </div>
                    
                    <div class="input-group">
                        <label>ğŸ“ ê¸°ì¡´ ë””ìŠ¤í¬ë¦½ì…˜ <span id="descSource" class="text-green-400"></span></label>
                        <textarea id="originalDesc" placeholder="ê¸°ì¡´ AI ë””ìŠ¤í¬ë¦½ì…˜ì´ ìˆë‹¤ë©´ ë¶™ì—¬ë„£ê¸°..."></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="generateScript()">
                        âœ¨ 20ì´ˆ ëŒ€ì‚¬ ìƒì„± (í…ìŠ¤íŠ¸ ì¶•ì•½ë§Œ - ë¹„ìš© ì ˆê°!)
                    </button>
                </div>
                
                <!-- í”„ë¡¬í”„íŠ¸ ë³µì‚¬ (Google AI Studioìš©) -->
                <div class="settings-panel">
                    <h3>ğŸ“‹ Google AI Studio í”„ë¡¬í”„íŠ¸</h3>
                    <div class="prompt-box" id="geminiPrompt">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ í”„ë¡¬í”„íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤...</div>
                    <button class="copy-btn" onclick="copyPrompt('gemini')">ğŸ“‹ ë³µì‚¬</button>
                </div>
                
                <!-- ìƒì„±ëœ ëŒ€ì‚¬ -->
                <div class="settings-panel">
                    <h3>ğŸ¤ ìƒì„±ëœ 20ì´ˆ ëŒ€ì‚¬</h3>
                    <textarea id="generatedScript" placeholder="AI Studio ê²°ê³¼ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ ìë™ ìƒì„±..."></textarea>
                </div>
                
                <!-- ë³‘ë ¬ ì²˜ë¦¬ ë²„íŠ¼ -->
                <button class="btn btn-success" onclick="startParallelProcess()">
                    ğŸš€ ì˜ìƒ ìƒì„± (TTS + D-ID ë³‘ë ¬)
                </button>
            </div>
            
            <!-- í”„ë¡œì„¸ìŠ¤ ìƒíƒœ -->
            <div class="process-status" id="processStatus" style="display:none;">
                <h3 class="text-sm mb-3">â³ ì²˜ë¦¬ ì¤‘...</h3>
                <div class="process-step" id="step-script">
                    <div class="step-icon pending">1</div>
                    <div>
                        <div class="font-medium">ëŒ€ì‚¬ ìƒì„±</div>
                        <div class="text-xs text-gray-500">Gemini 3.0 Flash</div>
                    </div>
                </div>
                <div class="process-step" id="step-tts">
                    <div class="step-icon pending">2</div>
                    <div>
                        <div class="font-medium">ìŒì„± ìƒì„±</div>
                        <div class="text-xs text-gray-500">Gemini 2.5 TTS</div>
                    </div>
                </div>
                <div class="process-step" id="step-video">
                    <div class="step-icon pending">3</div>
                    <div>
                        <div class="font-medium">ì˜ìƒ ìƒì„±</div>
                        <div class="text-xs text-gray-500">D-ID API</div>
                    </div>
                </div>
                <div class="process-step" id="step-merge">
                    <div class="step-icon pending">4</div>
                    <div>
                        <div class="font-medium">í•©ì„± ì™„ë£Œ</div>
                        <div class="text-xs text-gray-500">ìµœì¢… MP4</div>
                    </div>
                </div>
            </div>
            
            <!-- ì „ì²´ ê³µìœ ì˜ìƒ ìƒì„± -->
            <button class="btn btn-primary" id="generateAllBtn" onclick="generateShareVideo()" disabled>
                ğŸ¬ ê³µìœ ì˜ìƒ ìƒì„± (6ê°œ ìŠ¬ë¡¯)
            </button>
        </div>
        
        <!-- ê°¤ëŸ¬ë¦¬ íƒ­ -->
        <div id="tab-gallery" class="tab-content">
            <h3 class="text-sm text-gray-400 p-4 pb-0">ğŸ¬ ìƒì„±ëœ ê³µìœ ì˜ìƒ</h3>
            <div class="share-gallery" id="shareGallery">
                <div class="text-center text-gray-500 py-8" style="grid-column: span 2;">
                    ì•„ì§ ìƒì„±ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤
                </div>
            </div>
        </div>
        
        <!-- ì„¤ì • íƒ­ -->
        <div id="tab-settings" class="tab-content">
            <div class="settings-panel">
                <h3>ğŸ”‘ API í‚¤ ì„¤ì •</h3>
                
                <div class="input-group">
                    <label>D-ID API Key</label>
                    <div class="api-key-input">
                        <input type="password" id="didApiKey" placeholder="D-ID API í‚¤ ì…ë ¥...">
                        <button class="copy-btn" onclick="saveApiKey('did')">ì €ì¥</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        <a href="https://studio.d-id.com/" target="_blank" class="text-blue-400">D-ID Studio</a>ì—ì„œ ë°œê¸‰
                    </p>
                </div>
                
                <div class="input-group">
                    <label>Gemini API Key (ì„ íƒ)</label>
                    <div class="api-key-input">
                        <input type="password" id="geminiApiKey" placeholder="ìë™ ìƒì„± ì‹œ í•„ìš”...">
                        <button class="copy-btn" onclick="saveApiKey('gemini')">ì €ì¥</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        ìˆ˜ë™ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ì‹œ ë¶ˆí•„ìš”
                    </p>
                </div>
            </div>
            
            <div class="settings-panel">
                <h3>ğŸ“Š ì˜ìƒ ì„¤ì •</h3>
                
                <div class="input-group">
                    <label>í•´ìƒë„</label>
                    <select id="resolution" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white">
                        <option value="480p">480p (ìš©ëŸ‰ ìµœì í™”)</option>
                        <option value="720p" selected>720p (ê¶Œì¥)</option>
                        <option value="1080p">1080p (ê³ í™”ì§ˆ)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>ì˜ìƒ ê¸¸ì´</label>
                    <select id="duration" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white">
                        <option value="8">8ì´ˆ (ë¹ ë¥¸ ìƒì„±)</option>
                        <option value="15">15ì´ˆ</option>
                        <option value="20" selected>20ì´ˆ (ê¶Œì¥)</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-panel">
                <h3>ğŸ“‹ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</h3>
                <div class="prompt-box">ë‹¹ì‹ ì€ ì´ ì´ë¯¸ì§€ ì† ì£¼ì¸ê³µì…ë‹ˆë‹¤.
1ì¸ì¹­ ì‹œì ìœ¼ë¡œ ìì‹ ì„ ì†Œê°œí•˜ì„¸ìš”.
20ì´ˆ ë¶„ëŸ‰(100-120ì)ìœ¼ë¡œ ê°ì •ì´ ë‹´ê¸´ ëŒ€ì‚¬ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

í˜•ì‹:
- í˜ë¥´ì†Œë‚˜: (ì •ì²´)
- ë¶„ìœ„ê¸°: (nostalgic/proud/cheerful ë“±)
- ëŒ€ì‚¬: "1ì¸ì¹­ ëŒ€ì‚¬"</div>
            </div>
        </div>
    </div>
    
    <!-- ìƒì„¸ ë·° ëª¨ë‹¬ -->
    <div class="detail-modal" id="detailModal">
        <button class="close-btn" onclick="closeDetailModal()">âœ•</button>
        <video id="detailVideo" controls></video>
    </div>
    
    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>
    
    <!-- ê°€ì´ë“œ ì„ íƒ ëª¨ë‹¬ -->
    <div class="detail-modal" id="guideSelector" style="background: rgba(0,0,0,0.9);">
        <div style="max-width: 430px; margin: 0 auto; padding: 16px; height: 100%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 class="text-lg font-bold">ğŸ“‚ ë‚´ ê°€ì´ë“œ ì„ íƒ</h2>
                <button class="close-btn" onclick="closeGuideSelector()" style="position: static; width: 36px; height: 36px;">âœ•</button>
            </div>
            <p class="text-sm text-gray-400 mb-4">ê¸°ì¡´ ê°€ì´ë“œë¥¼ ì„ íƒí•˜ë©´ ì´ë¯¸ì§€ì™€ ë””ìŠ¤í¬ë¦½ì…˜ì´ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.</p>
            <div id="guideList" class="slot-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="text-center text-gray-500 py-8" style="grid-column: span 2;">
                    ë¡œë”© ì¤‘...
                </div>
            </div>
        </div>
    </div>

    <script>
        // === ìƒíƒœ ê´€ë¦¬ ===
        const slots = Array(6).fill(null).map((_, i) => ({
            id: i + 1,
            image: null,
            imageUrl: null, // DBì—ì„œ ê°€ì ¸ì˜¨ URL (D-ID ì§ì ‘ ì „ë‹¬ìš©)
            imageBase64: null,
            originalDesc: '',
            script: '',
            audioUrl: null,
            videoUrl: null,
            fromDB: false, // DBì—ì„œ ê°€ì ¸ì™”ëŠ”ì§€ ì—¬ë¶€ (ë¹„ìš© ì ˆê° í‘œì‹œ)
            guideId: null, // ì›ë³¸ ê°€ì´ë“œ ID
            status: 'empty' // empty, image, processing, ready
        }));
        
        let currentSlotIndex = 0;
        let generatedVideos = [];
        let myGuides = []; // DBì—ì„œ ê°€ì ¸ì˜¨ ê°€ì´ë“œ ëª©ë¡
        
        // === ì´ˆê¸°í™” ===
        function init() {
            renderSlots();
            loadApiKeys();
            loadGeneratedVideos();
            
            document.getElementById('imageInput').addEventListener('change', handleImageUpload);
        }
        
        // === ìŠ¬ë¡¯ ë Œë”ë§ ===
        function renderSlots() {
            const grid = document.getElementById('slotGrid');
            grid.innerHTML = slots.map((slot, i) => `
                <div class="slot ${slot.image ? 'filled' : ''}" onclick="selectSlot(${i})">
                    ${slot.image 
                        ? `<img src="${slot.image}" alt="ìŠ¬ë¡¯ ${i+1}">` 
                        : `<div class="text-2xl text-gray-600">+</div>`
                    }
                    <div class="slot-number">${i + 1}</div>
                    ${slot.status !== 'empty' ? `
                        <div class="slot-status ${slot.status}">${
                            slot.status === 'ready' ? 'âœ“' : 
                            slot.status === 'processing' ? 'â³' : 
                            slot.status === 'image' ? 'ğŸ“·' : ''
                        }</div>
                    ` : ''}
                </div>
            `).join('');
            
            // ì „ì²´ ìƒì„± ë²„íŠ¼ í™œì„±í™” ì²´í¬
            const readyCount = slots.filter(s => s.status === 'ready').length;
            document.getElementById('generateAllBtn').disabled = readyCount === 0;
        }
        
        // === ìŠ¬ë¡¯ ì„ íƒ ===
        function selectSlot(index) {
            currentSlotIndex = index;
            const slot = slots[index];
            
            document.getElementById('slotEditor').style.display = 'block';
            document.getElementById('currentSlotNum').textContent = index + 1;
            
            // DBì—ì„œ ê°€ì ¸ì˜¨ ê²½ìš° í‘œì‹œ
            const sourceIndicator = document.getElementById('sourceIndicator');
            const descSource = document.getElementById('descSource');
            if (slot.fromDB) {
                sourceIndicator.style.display = 'block';
                descSource.textContent = '(DBì—ì„œ ìë™ ë¡œë“œë¨)';
            } else {
                sourceIndicator.style.display = 'none';
                descSource.textContent = '';
            }
            
            if (slot.image) {
                document.getElementById('previewImage').src = slot.image;
                document.getElementById('previewImage').style.display = 'block';
                document.getElementById('uploadPlaceholder').style.display = 'none';
                document.getElementById('uploadZone').classList.add('has-image');
            } else {
                document.getElementById('previewImage').style.display = 'none';
                document.getElementById('uploadPlaceholder').style.display = 'block';
                document.getElementById('uploadZone').classList.remove('has-image');
            }
            
            document.getElementById('originalDesc').value = slot.originalDesc || '';
            document.getElementById('generatedScript').value = slot.script || '';
            
            updateGeminiPrompt();
        }
        
        // === ê°€ì´ë“œ ì„ íƒ ëª¨ë‹¬ ===
        async function openGuideSelector() {
            document.getElementById('guideSelector').classList.add('active');
            await loadMyGuides();
        }
        
        function closeGuideSelector() {
            document.getElementById('guideSelector').classList.remove('active');
        }
        
        async function loadMyGuides() {
            const guideList = document.getElementById('guideList');
            guideList.innerHTML = '<div class="text-center text-gray-500 py-8" style="grid-column: span 2;">ë¡œë”© ì¤‘...</div>';
            
            try {
                const response = await fetch('/api/guides');
                if (!response.ok) {
                    throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                }
                
                myGuides = await response.json();
                
                if (myGuides.length === 0) {
                    guideList.innerHTML = '<div class="text-center text-gray-500 py-8" style="grid-column: span 2;">ì €ì¥ëœ ê°€ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                guideList.innerHTML = myGuides.map((guide, i) => `
                    <div class="slot filled" onclick="selectGuide('${guide.id}')" style="cursor: pointer;">
                        <img src="${guide.imageUrl || '/images/placeholder.png'}" alt="${guide.title || 'ê°€ì´ë“œ'}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
                        <div class="slot-number" style="background: rgba(102, 126, 234, 0.9);">
                            ${guide.title ? guide.title.substring(0, 8) : 'ê°€ì´ë“œ ' + (i+1)}
                        </div>
                        ${guide.description || guide.aiGeneratedContent ? 
                            '<div class="slot-status ready">ğŸ“</div>' : ''
                        }
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('ê°€ì´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
                guideList.innerHTML = `<div class="text-center text-gray-500 py-8" style="grid-column: span 2;">
                    ${error.message}<br>
                    <button class="btn btn-secondary" onclick="closeGuideSelector()" style="margin-top: 12px;">ë‹«ê¸°</button>
                </div>`;
            }
        }
        
        function selectGuide(guideId) {
            const guide = myGuides.find(g => g.id === guideId);
            if (!guide) return;
            
            // ë¹ˆ ìŠ¬ë¡¯ ì°¾ê¸° ë˜ëŠ” í˜„ì¬ ìŠ¬ë¡¯ ì‚¬ìš©
            let targetIndex = slots.findIndex(s => s.status === 'empty');
            if (targetIndex === -1) {
                targetIndex = currentSlotIndex;
            }
            
            // ìŠ¬ë¡¯ì— ê°€ì´ë“œ ë°ì´í„° ì±„ìš°ê¸°
            slots[targetIndex].image = guide.imageUrl;
            slots[targetIndex].imageUrl = guide.imageUrl; // D-IDìš© URL
            slots[targetIndex].originalDesc = guide.aiGeneratedContent || guide.description || '';
            slots[targetIndex].fromDB = true;
            slots[targetIndex].guideId = guide.id;
            slots[targetIndex].status = 'image';
            
            closeGuideSelector();
            renderSlots();
            selectSlot(targetIndex);
            
            showToast(`"${guide.title || 'ê°€ì´ë“œ'}" ë¶ˆëŸ¬ì˜´ - ì´ë¯¸ì§€ ë¶„ì„ ë¶ˆí•„ìš”!`);
        }
        
        // === ì´ë¯¸ì§€ ì—…ë¡œë“œ ===
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                slots[currentSlotIndex].image = base64;
                slots[currentSlotIndex].imageBase64 = base64.split(',')[1];
                slots[currentSlotIndex].status = 'image';
                
                document.getElementById('previewImage').src = base64;
                document.getElementById('previewImage').style.display = 'block';
                document.getElementById('uploadPlaceholder').style.display = 'none';
                document.getElementById('uploadZone').classList.add('has-image');
                
                renderSlots();
                updateGeminiPrompt();
            };
            reader.readAsDataURL(file);
        }
        
        // === Gemini í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸ ===
        function updateGeminiPrompt() {
            const slot = slots[currentSlotIndex];
            const duration = document.getElementById('duration')?.value || 20;
            const charCount = duration === '8' ? '40-60' : duration === '15' ? '80-100' : '100-120';
            
            let prompt;
            
            // DBì—ì„œ ê°€ì ¸ì˜¨ ê²½ìš°: ì´ë¯¸ì§€ ë¶„ì„ ë¶ˆí•„ìš”, í…ìŠ¤íŠ¸ë§Œ ì¶•ì•½
            if (slot.fromDB && slot.originalDesc) {
                prompt = `ë‹¤ìŒ ì„¤ëª…ì„ ë°”íƒ•ìœ¼ë¡œ 1ì¸ì¹­ ì‹œì ì˜ ${duration}ì´ˆ ë¶„ëŸ‰(${charCount}ì) ëŒ€ì‚¬ë¥¼ ì‘ì„±í•˜ì„¸ìš”.
ì£¼ì¸ê³µì´ ì§ì ‘ ìì‹ ì„ ì†Œê°œí•˜ëŠ” í˜•ì‹ì…ë‹ˆë‹¤.

[ê¸°ì¡´ ì„¤ëª…]
"${slot.originalDesc.substring(0, 500)}"

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ:
- í˜ë¥´ì†Œë‚˜: (í”¼ì‚¬ì²´ ì •ì²´)
- ë¶„ìœ„ê¸°: (nostalgic, proud, mysterious, cheerful ë“±)
- ëŒ€ì‚¬: "1ì¸ì¹­ ëŒ€ì‚¬"

âš ï¸ ì´ë¯¸ì§€ ë¶„ì„ ë¶ˆí•„ìš” - í…ìŠ¤íŠ¸ë§Œ ì¶•ì•½ (ë¹„ìš© ì ˆê°)`;
            } else {
                // ìƒˆ ì´ë¯¸ì§€: ì´ë¯¸ì§€ ë¶„ì„ í•„ìš”
                prompt = `ë‹¹ì‹ ì€ ì´ ì´ë¯¸ì§€ ì† ì£¼ì¸ê³µ(ìŒì‹, ê±´ë¬¼, ì˜ˆìˆ í’ˆ, í’ê²½, ì™€ì¸ ë“±)ì…ë‹ˆë‹¤.
1ì¸ì¹­ ì‹œì ìœ¼ë¡œ ìì‹ ì„ ì†Œê°œí•˜ê³  ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”.
${duration}ì´ˆ ë¶„ëŸ‰(í•œêµ­ì–´ ${charCount}ì)ìœ¼ë¡œ ê°ì •ì´ ë‹´ê¸´ ëŒ€ì‚¬ë¥¼ ì‘ì„±í•˜ì„¸ìš”.`;
                
                if (slot.originalDesc) {
                    prompt += `

ê¸°ì¡´ ì„¤ëª… ì°¸ê³ :
"${slot.originalDesc.substring(0, 200)}..."`;
                }
                
                prompt += `

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ:
- í˜ë¥´ì†Œë‚˜: (í”¼ì‚¬ì²´ ì •ì²´)
- ë¶„ìœ„ê¸°: (nostalgic, proud, mysterious, cheerful ë“±)
- ëŒ€ì‚¬: "1ì¸ì¹­ ëŒ€ì‚¬"`;
            }
            
            document.getElementById('geminiPrompt').textContent = prompt;
        }
        
        // === í”„ë¡¬í”„íŠ¸ ë³µì‚¬ ===
        function copyPrompt(type) {
            const text = document.getElementById('geminiPrompt').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('í”„ë¡¬í”„íŠ¸ ë³µì‚¬ë¨! AI Studioì— ë¶™ì—¬ë„£ê¸°');
            });
        }
        
        // === ëŒ€ì‚¬ ìƒì„± (ì„œë²„ API ìë™ í˜¸ì¶œ) ===
        async function generateScript() {
            const slot = slots[currentSlotIndex];
            if (!slot.image && !slot.description) {
                showToast('ì´ë¯¸ì§€ ë˜ëŠ” ê°€ì´ë“œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
                return;
            }
            
            updateStepStatus('script', 'processing');
            showToast('AI ë¶„ì„ ì¤‘...');
            
            try {
                const requestBody = {
                    language: 'ko',
                    duration: 20,
                    generateAudio: true
                };
                
                // DBì—ì„œ ê°€ì ¸ì˜¨ ê²½ìš° (ì„¤ëª… ìˆìŒ) â†’ í…ìŠ¤íŠ¸ ë¶„ì„ë§Œ (ë¹„ìš© ì ˆê° 90%)
                if (slot.description) {
                    requestBody.description = slot.description;
                    requestBody.imageUrl = slot.imageUrl || null;
                    console.log('ğŸ“ í…ìŠ¤íŠ¸ ë¶„ì„ ëª¨ë“œ (ë¹„ìš© ì ˆê°)');
                } else if (slot.image) {
                    // ìƒˆ ì—…ë¡œë“œ ì´ë¯¸ì§€ â†’ ì´ë¯¸ì§€ ë¶„ì„ í•„ìš”
                    requestBody.imageBase64 = slot.image.replace(/^data:image\/\w+;base64,/, '');
                    console.log('ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¶„ì„ ëª¨ë“œ');
                }
                
                const response = await fetch('/api/dream-studio/generate-full', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
                
                const result = await response.json();
                
                // ë¶„ì„ ê²°ê³¼ ì €ì¥
                slot.category = result.analysis.category;
                slot.categoryKo = result.analysis.categoryKo;
                slot.persona = result.analysis.persona;
                slot.mood = result.analysis.mood;
                slot.script = result.analysis.script;
                slot.keywords = result.analysis.keywords;
                slot.voiceName = result.analysis.voiceName;
                
                // ì˜¤ë””ì˜¤ ì €ì¥ (ìˆìœ¼ë©´)
                if (result.audio) {
                    slot.audioBase64 = result.audio.audioBase64;
                    slot.audioMimeType = result.audio.mimeType;
                }
                
                // UI ì—…ë°ì´íŠ¸
                const keywords = result.analysis.keywords || [];
                const scriptEl = document.getElementById('generatedScript');
                if (scriptEl) scriptEl.value = result.analysis.script || '';
                
                // ê²°ê³¼ ì •ë³´ë¥¼ ì½˜ì†”ì— ì¶œë ¥ (ë””ë²„ê¹…ìš©)
                console.log('âœ… AI ë¶„ì„ ê²°ê³¼:', {
                    category: result.analysis.categoryKo,
                    persona: result.analysis.persona,
                    mood: result.analysis.mood,
                    keywords: keywords,
                    processingTime: result.processingTime + 'ms',
                    hasTTS: !!result.audio
                });
                
                updateStepStatus('script', 'done');
                if (result.audio) updateStepStatus('tts', 'done');
                
                showToast(`ë¶„ì„ ì™„ë£Œ! ${result.analysis.categoryKo} - ${result.analysis.persona}`);
                renderSlots();
                
            } catch (error) {
                console.error('ëŒ€ì‚¬ ìƒì„± ì˜¤ë¥˜:', error);
                showToast('ì—ëŸ¬: ' + error.message);
                updateStepStatus('script', 'error');
            }
        }
        
        // === ì˜ìƒ ìƒì„± (ì„œë²„ API í˜¸ì¶œ) ===
        async function startParallelProcess() {
            const slot = slots[currentSlotIndex];
            const script = document.getElementById('generatedScript')?.value?.trim() || slot.script;
            
            if (!slot.image && !slot.imageUrl) {
                showToast('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”');
                return;
            }
            
            if (!script) {
                showToast('ëŒ€ì‚¬ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”');
                return;
            }
            
            slot.script = script;
            slot.status = 'processing';
            renderSlots();
            
            document.getElementById('processStatus').style.display = 'block';
            updateStepStatus('script', 'done');
            
            // ì„œë²„ APIë¡œ D-ID ì˜ìƒ ìƒì„± (API í‚¤ëŠ” ì„œë²„ì—ì„œ ê´€ë¦¬)
            try {
                updateStepStatus('tts', 'processing');
                updateStepStatus('video', 'processing');
                showToast('D-ID ì˜ìƒ ìƒì„± ì¤‘... (ì•½ 1ë¶„ ì†Œìš”)');
                
                const requestBody = {
                    script: script,
                    voiceName: 'ko-KR-SunHiNeural'
                };
                
                // DBì—ì„œ ê°€ì ¸ì˜¨ ê²½ìš° URL ì‚¬ìš©, ì•„ë‹ˆë©´ base64
                if (slot.imageUrl && slot.imageUrl.startsWith('http')) {
                    requestBody.imageUrl = slot.imageUrl;
                    console.log('ğŸ¬ ì„œë²„ API: ì´ë¯¸ì§€ URL ì‚¬ìš©');
                } else if (slot.image) {
                    requestBody.imageBase64 = slot.image.replace(/^data:image\/\w+;base64,/, '');
                    console.log('ğŸ¬ ì„œë²„ API: Base64 ì—…ë¡œë“œ');
                }
                
                const response = await fetch('/api/dream-studio/generate-did-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'D-ID ì˜ìƒ ìƒì„± ì‹¤íŒ¨');
                }
                
                const result = await response.json();
                
                updateStepStatus('tts', 'done');
                updateStepStatus('video', 'done');
                updateStepStatus('merge', 'done');
                
                slot.videoUrl = result.videoUrl;
                slot.status = 'ready';
                renderSlots();
                
                console.log('âœ… ì˜ìƒ ìƒì„± ì™„ë£Œ:', result);
                showToast(`ì˜ìƒ ìƒì„± ì™„ë£Œ! (${Math.round(result.processingTime/1000)}ì´ˆ)`);
                
            } catch (error) {
                console.error('ì˜ìƒ ìƒì„± ì˜¤ë¥˜:', error);
                showToast('ì—ëŸ¬: ' + error.message);
                updateStepStatus('video', 'error');
                slot.status = 'image';
                renderSlots();
            }
        }
        
        // === ì›í´ë¦­ ì „ì²´ ìƒì„± (ë¶„ì„ â†’ D-ID ì˜ìƒ) ===
        async function createVideoOneClick() {
            const slot = slots[currentSlotIndex];
            
            if (!slot.image && !slot.imageUrl && !slot.description) {
                showToast('ì´ë¯¸ì§€ ë˜ëŠ” ê°€ì´ë“œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
                return;
            }
            
            slot.status = 'processing';
            renderSlots();
            document.getElementById('processStatus').style.display = 'block';
            
            updateStepStatus('script', 'processing');
            showToast('ğŸ¬ ì›í´ë¦­ ì˜ìƒ ìƒì„± ì‹œì‘...');
            
            try {
                const requestBody = {
                    language: 'ko',
                    duration: 20
                };
                
                // ì„¤ëª…ì´ ìˆìœ¼ë©´ í…ìŠ¤íŠ¸ ë¶„ì„ (ë¹„ìš© ì ˆê°)
                if (slot.description) {
                    requestBody.description = slot.description;
                    console.log('ğŸ“ í…ìŠ¤íŠ¸ ë¶„ì„ ëª¨ë“œ');
                } else if (slot.image) {
                    requestBody.imageBase64 = slot.image.replace(/^data:image\/\w+;base64,/, '');
                    console.log('ğŸ–¼ï¸ ì´ë¯¸ì§€ ë¶„ì„ ëª¨ë“œ');
                }
                
                // ì˜ìƒìš© ì´ë¯¸ì§€
                if (slot.imageUrl && slot.imageUrl.startsWith('http')) {
                    requestBody.imageUrl = slot.imageUrl;
                } else if (slot.image) {
                    requestBody.imageBase64 = slot.image.replace(/^data:image\/\w+;base64,/, '');
                }
                
                const response = await fetch('/api/dream-studio/create-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ì˜ìƒ ìƒì„± ì‹¤íŒ¨');
                }
                
                const result = await response.json();
                
                // ê²°ê³¼ ì €ì¥
                slot.category = result.analysis.category;
                slot.categoryKo = result.analysis.categoryKo;
                slot.persona = result.analysis.persona;
                slot.mood = result.analysis.mood;
                slot.script = result.analysis.script;
                slot.videoUrl = result.videoUrl;
                slot.status = 'ready';
                
                // UI ì—…ë°ì´íŠ¸
                const scriptEl = document.getElementById('generatedScript');
                if (scriptEl) scriptEl.value = result.analysis.script;
                
                updateStepStatus('script', 'done');
                updateStepStatus('tts', 'done');
                updateStepStatus('video', 'done');
                updateStepStatus('merge', 'done');
                
                renderSlots();
                
                console.log('âœ… ì›í´ë¦­ ì˜ìƒ ìƒì„± ì™„ë£Œ:', result);
                showToast(`ğŸ¬ ì™„ë£Œ! ${result.analysis.categoryKo} - ${Math.round(result.processingTime/1000)}ì´ˆ`);
                
            } catch (error) {
                console.error('ì›í´ë¦­ ìƒì„± ì˜¤ë¥˜:', error);
                showToast('ì—ëŸ¬: ' + error.message);
                updateStepStatus('script', 'error');
                slot.status = 'image';
                renderSlots();
            }
        }
        
        // === í”„ë¡œì„¸ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸ ===
        function updateStepStatus(step, status) {
            const el = document.querySelector(`#step-${step} .step-icon`);
            if (el) {
                el.className = `step-icon ${status}`;
                el.textContent = status === 'done' ? 'âœ“' : status === 'error' ? 'âœ•' : el.textContent;
            }
        }
        
        // === ì „ì²´ ê³µìœ ì˜ìƒ ìƒì„± ===
        async function generateShareVideo() {
            const readySlots = slots.filter(s => s.status === 'ready');
            if (readySlots.length === 0) {
                showToast('ì™„ì„±ëœ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ê°¤ëŸ¬ë¦¬ì— ì¶”ê°€
            const shareVideo = {
                id: Date.now(),
                createdAt: new Date().toISOString(),
                slots: readySlots.map(s => ({
                    image: s.image,
                    videoUrl: s.videoUrl,
                    script: s.script
                }))
            };
            
            generatedVideos.push(shareVideo);
            localStorage.setItem('dreamStudioVideos', JSON.stringify(generatedVideos));
            
            showToast('ê³µìœ ì˜ìƒ ì €ì¥ ì™„ë£Œ!');
            switchTab('gallery');
            renderGallery();
        }
        
        // === ê°¤ëŸ¬ë¦¬ ë Œë”ë§ ===
        function renderGallery() {
            const gallery = document.getElementById('shareGallery');
            
            if (generatedVideos.length === 0) {
                gallery.innerHTML = `
                    <div class="text-center text-gray-500 py-8" style="grid-column: span 2;">
                        ì•„ì§ ìƒì„±ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤
                    </div>
                `;
                return;
            }
            
            gallery.innerHTML = generatedVideos.flatMap(video => 
                video.slots.map((slot, i) => `
                    <div class="gallery-item" onclick="openDetailModal('${slot.videoUrl}')">
                        ${slot.videoUrl 
                            ? `<video src="${slot.videoUrl}" muted></video>`
                            : `<img src="${slot.image}" alt="">`
                        }
                        <div class="play-overlay">
                            <div class="play-icon">â–¶</div>
                        </div>
                    </div>
                `)
            ).join('');
        }
        
        // === ìƒì„¸ ëª¨ë‹¬ ===
        function openDetailModal(videoUrl) {
            if (!videoUrl) return;
            document.getElementById('detailVideo').src = videoUrl;
            document.getElementById('detailModal').classList.add('active');
        }
        
        function closeDetailModal() {
            document.getElementById('detailVideo').pause();
            document.getElementById('detailModal').classList.remove('active');
        }
        
        // === íƒ­ ì „í™˜ ===
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        // === API í‚¤ ê´€ë¦¬ ===
        function saveApiKey(type) {
            const input = document.getElementById(`${type}ApiKey`);
            localStorage.setItem(`${type}ApiKey`, input.value);
            showToast(`${type.toUpperCase()} API í‚¤ ì €ì¥ë¨`);
        }
        
        function loadApiKeys() {
            const didKey = localStorage.getItem('didApiKey');
            const geminiKey = localStorage.getItem('geminiApiKey');
            
            if (didKey) document.getElementById('didApiKey').value = didKey;
            if (geminiKey) document.getElementById('geminiApiKey').value = geminiKey;
        }
        
        function loadGeneratedVideos() {
            const saved = localStorage.getItem('dreamStudioVideos');
            if (saved) {
                generatedVideos = JSON.parse(saved);
                renderGallery();
            }
        }
        
        // === í† ìŠ¤íŠ¸ ===
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // === ì‹œì‘ ===
        init();
    </script>
</body>
</html>
