<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: #f5f5f5;
        }
        .tab-button {
            transition: all 0.2s;
        }
        .tab-button.active {
            background: white;
            border-bottom: 2px solid #4285F4;
        }
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .max-w-7xl {
                padding: 1rem;
            }
            #guidesGrid {
                grid-template-columns: 1fr !important;
            }
            #createShareBtn {
                font-size: 0.875rem;
                padding: 0.5rem 1rem;
            }
            .tab-button {
                font-size: 0.875rem;
                padding: 0.75rem 1rem;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1023px) {
            #guidesGrid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        @media (min-width: 1024px) {
            #guidesGrid {
                grid-template-columns: repeat(3, 1fr) !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <!-- í—¤ë” -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
            <button onclick="window.close()" class="px-4 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition">
                ë‹«ê¸°
            </button>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="flex border-b">
                <button onclick="showTab('overview')" id="tab-overview" class="tab-button active px-6 py-3 font-medium text-gray-700">
                    ìš”ì•½
                </button>
                <button onclick="showTab('content')" id="tab-content" class="tab-button px-6 py-3 font-medium text-gray-500 hover:text-gray-700">
                    ì½˜í…ì¸ 
                </button>
                <button onclick="showTab('guides')" id="tab-guides" class="tab-button px-6 py-3 font-medium text-gray-500 hover:text-gray-700">
                    ğŸ” ê°€ì´ë“œ ê´€ë¦¬
                </button>
                <button onclick="showTab('revenue')" id="tab-revenue" class="tab-button px-6 py-3 font-medium text-gray-500 hover:text-gray-700">
                    ìˆ˜ìµ
                </button>
                <button onclick="showTab('stats')" id="tab-stats" class="tab-button px-6 py-3 font-medium text-gray-500 hover:text-gray-700">
                    í†µê³„
                </button>
            </div>
        </div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-blue-500"></div>
            <p class="mt-4 text-gray-600">ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>

        <!-- ìš”ì•½ íƒ­ -->
        <div id="content-overview" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- ê°€ì…ì -->
                <div class="stat-card bg-white rounded-lg p-6 shadow-sm">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">ê°€ì…ì</h3>
                    <p id="totalUsers" class="text-3xl font-bold text-gray-900 mb-1">-</p>
                    <p class="text-sm text-gray-500">ìµœê·¼ 7ì¼: <span id="recentUsers" class="font-semibold text-blue-600">-</span>ëª…</p>
                </div>

                <!-- AI í˜¸ì¶œ íšŸìˆ˜ -->
                <div class="stat-card bg-white rounded-lg p-6 shadow-sm">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">AI í˜¸ì¶œ íšŸìˆ˜</h3>
                    <p id="totalApiCalls" class="text-3xl font-bold text-gray-900 mb-1">-</p>
                    <p class="text-sm text-gray-500">ì˜ˆìƒ ë¹„ìš©: <span id="estimatedCost" class="font-semibold text-orange-600">-</span></p>
                </div>

                <!-- ê³µìœ  ë§í¬ -->
                <div class="stat-card bg-white rounded-lg p-6 shadow-sm">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">ê³µìœ  ë§í¬</h3>
                    <p id="totalShares" class="text-3xl font-bold text-gray-900 mb-1">-</p>
                    <p class="text-sm text-gray-500">ìƒì„±ëœ ë§í¬</p>
                </div>

                <!-- ê³µìœ  ì¡°íšŒìˆ˜ -->
                <div class="stat-card bg-white rounded-lg p-6 shadow-sm">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">ê³µìœ  ì¡°íšŒìˆ˜</h3>
                    <p id="totalViews" class="text-3xl font-bold text-gray-900 mb-1">-</p>
                    <p class="text-sm text-gray-500">ëˆ„ì  ì¡°íšŒ</p>
                </div>
            </div>

            <!-- ë¡œê·¸ì¸ ë°©ì‹ -->
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">ë¡œê·¸ì¸ ë°©ì‹ë³„ ì‚¬ìš©ì</h2>
                <div id="providerStats" class="space-y-3">
                    <!-- ë™ì  ìƒì„± -->
                </div>
            </div>
        </div>

        <!-- ì½˜í…ì¸  íƒ­ (from index.html Featured ê°¤ëŸ¬ë¦¬ ê´€ë¦¬) -->
        <div id="content-content" class="hidden">
            <!-- â­ Featured ê°¤ëŸ¬ë¦¬ ê´€ë¦¬ (ê´€ë¦¬ì ì „ìš©) -->
            <div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-yellow-500">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold text-gray-800">â­ Featured ê°¤ëŸ¬ë¦¬ ê´€ë¦¬</h2>
                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">ê´€ë¦¬ì ì „ìš©</span>
                </div>
                <p class="text-sm text-gray-500 mb-4">ì¶”ì²œ ê°¤ëŸ¬ë¦¬ì— í‘œì‹œí•  ê³µìœ  í˜ì´ì§€ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš” (ìµœëŒ€ 3ê°œ)</p>
                
                <div class="space-y-4">
                    <!-- ê²€ìƒ‰ì°½ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ” ê³µìœ  í˜ì´ì§€ ì´ë¦„ ê²€ìƒ‰</label>
                        <input 
                            type="text" 
                            id="shareSearchInput" 
                            placeholder="ì˜ˆ: ì² ìˆ˜ì•„ë¹  íŒŒë¦¬3ì¼ì—¬í–‰" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 text-base"
                            data-testid="input-share-search"
                        />
                    </div>
                    
                    <!-- ê²€ìƒ‰ ê²°ê³¼ -->
                    <div id="searchResults" class="space-y-2 max-h-80 overflow-y-auto">
                        <p class="text-sm text-gray-400 text-center py-4">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                    </div>
                </div>
                
                <!-- í˜„ì¬ Featured ëª©ë¡ -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">í˜„ì¬ Featured (<span id="featuredCount">0</span>/3)</h3>
                    <div id="featuredList" class="space-y-2">
                        <p class="text-sm text-gray-400">ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>

            <!-- ì „ì²´ ê³µìœ  ê´€ë¦¬ -->
            <div class="bg-white rounded-lg p-6 shadow-sm mt-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">ì „ì²´ ê³µìœ  ê´€ë¦¬</h2>
                    <div class="flex gap-3">
                        <button onclick="migrateToV2()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            v1â†’v2 ë§ˆì´ê·¸ë ˆì´ì…˜
                        </button>
                        <input type="text" id="allSharesSearch" placeholder="ê²€ìƒ‰..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                        <select id="sortOrder" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                            <option value="latest">ìµœì‹ ìˆœ</option>
                            <option value="views">ì¡°íšŒìˆ˜ìˆœ</option>
                            <option value="name">ì´ë¦„ìˆœ</option>
                        </select>
                    </div>
                </div>
                <div id="allSharesList" class="space-y-3">
                    <!-- ë™ì  ìƒì„± -->
                </div>
                <div class="mt-4 text-center">
                    <button id="loadMoreBtn" onclick="loadMore()" class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                        ë” ë³´ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- ê°€ì´ë“œ ê´€ë¦¬ íƒ­ -->
        <div id="content-guides" class="hidden">
            <div class="space-y-6">
                <!-- ê²€ìƒ‰ ë° í•„í„° -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">ê°€ì´ë“œ ê²€ìƒ‰ ë° í•„í„°</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="guideLocationSearch" placeholder="ìœ„ì¹˜ ê²€ìƒ‰ (ì˜ˆ: ë² ë¥´ì‚¬ìœ , ì—í íƒ‘)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                        <input type="text" id="guideTagsSearch" placeholder="íƒœê·¸ ê²€ìƒ‰ (ì‰¼í‘œ êµ¬ë¶„, ì˜ˆ: ê¶ì „,ì—­ì‚¬)" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="searchGuides()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition">
                            ğŸ” ê²€ìƒ‰
                        </button>
                        <button onclick="resetGuideFilters()" class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                            ì´ˆê¸°í™”
                        </button>
                        <span id="guideCount" class="ml-auto self-center text-sm text-gray-500">ì´ 0ê°œ</span>
                    </div>
                </div>

                <!-- ê°€ì´ë“œ ê·¸ë¦¬ë“œ -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">ê°€ì´ë“œ ëª©ë¡</h2>
                        <button id="createShareBtn" onclick="openCreateShareModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            ì„ íƒí•œ ê°€ì´ë“œë¡œ ê³µìœ  í˜ì´ì§€ ë§Œë“¤ê¸° (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                    <div id="guidesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                    <div class="mt-4 text-center">
                        <button id="loadMoreGuidesBtn" onclick="loadMoreGuides()" class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition">
                            ë” ë³´ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìˆ˜ìµ íƒ­ -->
        <div id="content-revenue" class="hidden">
            <div class="bg-white rounded-lg p-12 shadow-sm text-center">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">ì¤€ë¹„ ì¤‘</h2>
                <p class="text-gray-500">Phase 2ì—ì„œ í¬ë ˆë”§ ë° ê²°ì œ ê¸°ëŠ¥ì´ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- í†µê³„ íƒ­ -->
        <div id="content-stats" class="hidden">
            <div class="space-y-6">
                <!-- ì¼ë³„ ì¶”ì´ -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">ì¼ë³„ í™œë™ ì¶”ì´ (ìµœê·¼ 7ì¼)</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-3 px-4 text-sm font-medium text-gray-500">ë‚ ì§œ</th>
                                    <th class="text-center py-3 px-4 text-sm font-medium text-gray-500">ì‹ ê·œ ê°€ì…</th>
                                    <th class="text-center py-3 px-4 text-sm font-medium text-gray-500">AI í˜¸ì¶œ</th>
                                    <th class="text-center py-3 px-4 text-sm font-medium text-gray-500">ê³µìœ  ë§í¬</th>
                                </tr>
                            </thead>
                            <tbody id="dailyTrends">
                                <!-- ë™ì  ìƒì„± -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ì‚¬ìš©ì í–‰ë™ -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">ì‚¬ìš©ì í–‰ë™</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- ë””ë°”ì´ìŠ¤ ë¶„í¬ -->
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 mb-3">ë””ë°”ì´ìŠ¤ ë¶„í¬</h3>
                            <div id="deviceStats" class="space-y-2">
                                <!-- ë™ì  ìƒì„± -->
                            </div>
                        </div>
                        <!-- ë¸Œë¼ìš°ì € ë¶„í¬ -->
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 mb-3">ë¸Œë¼ìš°ì € ë¶„í¬</h3>
                            <div id="browserStats" class="space-y-2">
                                <!-- ë™ì  ìƒì„± -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI ì„±ëŠ¥ -->
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">AI ì„±ëŠ¥</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 mb-2">í‰ê·  ì‘ë‹µ ì‹œê°„</h3>
                            <p id="avgResponseTime" class="text-2xl font-bold text-gray-900">-</p>
                            <p class="text-xs text-gray-500 mt-1">ëª©í‘œ: 2-2.5ì´ˆ</p>
                        </div>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 mb-2">ì„±ê³µë¥ </h3>
                            <p id="successRate" class="text-2xl font-bold text-green-600">-</p>
                        </div>
                        <div>
                            <h3 class="text-sm font-medium text-gray-500 mb-2">ì—ëŸ¬ìœ¨</h3>
                            <p id="errorRate" class="text-2xl font-bold text-red-600">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'overview';
        let allShares = [];
        let displayedShares = 0;
        const SHARES_PER_PAGE = 20;

        // íƒ­ ì „í™˜
        function showTab(tab) {
            currentTab = tab;
            
            // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
            ['overview', 'content', 'guides', 'revenue', 'stats'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('active');
                document.getElementById(`tab-${t}`).classList.add('text-gray-500');
                document.getElementById(`tab-${t}`).classList.remove('text-gray-700');
            });
            
            // ì„ íƒëœ íƒ­ í‘œì‹œ
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-500');
            document.getElementById(`tab-${tab}`).classList.add('text-gray-700');
            
            // íƒ­ë³„ ë°ì´í„° ë¡œë“œ
            if (tab === 'content') {
                loadAdminData();
            } else if (tab === 'guides') {
                searchGuides();
                loadCurrentFeatured();
            } else if (tab === 'stats') {
                loadStats();
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Featured ê°¤ëŸ¬ë¦¬ ê´€ë¦¬ í•¨ìˆ˜ë“¤ (from index.js)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadAdminData() {
            await loadFeaturedList();
            await loadAllShares(); // ì „ì²´ ê³µìœ  ëª©ë¡ë„ ë¡œë“œ
            
            // ê²€ìƒ‰ì°½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const searchInput = document.getElementById('shareSearchInput');
            if (searchInput && !searchInput.dataset.listenerAdded) {
                searchInput.dataset.listenerAdded = 'true';
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchShares(e.target.value);
                    }, 300); // 300ms ë””ë°”ìš´ìŠ¤
                });
            }
        }

        async function searchShares(query) {
            const resultsContainer = document.getElementById('searchResults');
            if (!resultsContainer) return;

            if (!query || query.trim().length === 0) {
                resultsContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>';
                return;
            }

            try {
                resultsContainer.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ê²€ìƒ‰ ì¤‘...</p>';
                
                const response = await fetch(`/api/admin/all-shares?search=${encodeURIComponent(query)}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨');
                
                const shares = await response.json();
                
                if (!shares || shares.length === 0) {
                    resultsContainer.innerHTML = `
                        <p class="text-sm text-gray-400 text-center py-4">
                            "<span class="font-semibold">${query}</span>" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤
                        </p>
                    `;
                    return;
                }
                
                resultsContainer.innerHTML = shares.map(share => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:border-yellow-400 transition-colors">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 truncate">${share.name}</p>
                            <div class="flex items-center gap-3 mt-1">
                                <span class="text-xs text-gray-500">ğŸ“¥ ${share.downloadCount || 0}íšŒ</span>
                                <span class="text-xs text-gray-400">${new Date(share.createdAt).toLocaleDateString()}</span>
                                ${share.featured ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">â­ Featured</span>' : ''}
                            </div>
                        </div>
                        ${!share.featured ? `
                            <button 
                                onclick="addFeaturedById('${share.id}')" 
                                class="ml-3 px-3 py-1.5 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors whitespace-nowrap"
                                data-testid="button-add-featured-${share.id}">
                                â­ ì¶”ê°€
                            </button>
                        ` : `
                            <span class="ml-3 px-3 py-1.5 bg-gray-200 text-gray-500 text-sm font-medium rounded cursor-not-allowed whitespace-nowrap">
                                ì´ë¯¸ ì¶”ê°€ë¨
                            </span>
                        `}
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('ê³µìœ  í˜ì´ì§€ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                resultsContainer.innerHTML = '<p class="text-sm text-red-400 text-center py-4">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>';
            }
        }

        async function loadFeaturedList() {
            try {
                const response = await fetch('/api/admin/featured', {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load featured');
                
                const featured = await response.json();
                
                const list = document.getElementById('featuredList');
                const count = document.getElementById('featuredCount');
                
                if (count) count.textContent = featured.length;
                
                if (!list) return;
                
                if (!featured || featured.length === 0) {
                    list.innerHTML = '<p class="text-sm text-gray-400">Featured í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }
                
                list.innerHTML = featured.map(page => `
                    <div class="flex items-center justify-between p-2 bg-yellow-50 rounded">
                        <span class="text-sm font-medium text-gray-800">${page.name}</span>
                        <div class="flex items-center gap-2">
                            <button onclick="editFeatured('${page.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                âœï¸ í¸ì§‘
                            </button>
                            <button onclick="removeFeatured('${page.id}')" class="text-red-500 hover:text-red-700 text-sm font-medium">
                                âœ• ì œê±°
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Featured ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                const list = document.getElementById('featuredList');
                if (list) list.innerHTML = '<p class="text-sm text-red-400">ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        window.addFeaturedById = async function(shareId) {
            if (!shareId) {
                alert('ê³µìœ  í˜ì´ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/featured/${shareId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('â­ Featuredì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    await loadFeaturedList();
                    // ê²€ìƒ‰ ê²°ê³¼ ë‹¤ì‹œ ë¡œë“œí•´ì„œ "ì´ë¯¸ ì¶”ê°€ë¨" í‘œì‹œ
                    const searchInput = document.getElementById('shareSearchInput');
                    if (searchInput && searchInput.value) {
                        await searchShares(searchInput.value);
                    }
                } else {
                    alert(data.error || 'Featured ì¶”ê°€ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Featured ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('Featured ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }
        };

        window.removeFeatured = async function(shareId) {
            if (!confirm('Featuredì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const response = await fetch(`/api/admin/featured/${shareId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Featuredì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
                    await loadFeaturedList();
                } else {
                    alert(data.error || 'Featured ì œê±° ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Featured ì œê±° ì˜¤ë¥˜:', error);
                alert('Featured ì œê±° ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            }
        };

        // Featured í¸ì§‘ ëª¨ë‹¬
        window.editFeatured = async function(id) {
            try {
                // 1. ê´€ë¦¬ììš© APIë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const res = await fetch(`/api/admin/featured/${id}/data`, {
                    credentials: 'include'
                });
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                }
                const data = await res.json();
                const { page, guides } = data;
                
                console.log('ğŸ“Š í¸ì§‘ ë°ì´í„°:', { page, guides, guidesCount: guides?.length });
                
                // 2. ëª¨ë‹¬ ì…ë ¥ í•„ë“œ ì±„ìš°ê¸°
                document.getElementById('editTitle').value = page.name || '';
                document.getElementById('editSender').value = page.sender || 'ì—¬í–‰ì';
                document.getElementById('editLocation').value = page.location || 'ë¯¸ì§€ì •';
                document.getElementById('editDate').value = page.date || new Date(page.createdAt).toISOString().split('T')[0];
                
                // 3. ëª¨ë°”ì¼ ì¹œí™”ì  ê°€ì´ë“œ ë¦¬ìŠ¤íŠ¸ ìƒì„± (ìœ„/ì•„ë˜ ë²„íŠ¼)
                const guideListHtml = guides.map((guide, index) => {
                    const imgSrc = guide.imageUrl || '';
                    const isFirst = index === 0;
                    const isLast = index === guides.length - 1;
                    return `
                        <div class="guide-item flex items-center gap-2 p-3 bg-white rounded-lg border-2 border-gray-300 mb-2" data-guide-id="${guide.id}">
                            <img src="${imgSrc}" alt="ê°€ì´ë“œ ${index + 1}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px; flex-shrink: 0;">
                            <span class="font-medium text-gray-700 flex-1">ê°€ì´ë“œ ${index + 1}</span>
                            <div class="flex flex-col gap-1">
                                <button onclick="moveGuideUp(this)" ${isFirst ? 'disabled' : ''} class="px-3 py-1 bg-blue-500 text-white rounded disabled:bg-gray-300 disabled:cursor-not-allowed text-lg font-bold" style="min-width: 40px; min-height: 36px;">â–²</button>
                                <button onclick="moveGuideDown(this)" ${isLast ? 'disabled' : ''} class="px-3 py-1 bg-blue-500 text-white rounded disabled:bg-gray-300 disabled:cursor-not-allowed text-lg font-bold" style="min-width: 40px; min-height: 36px;">â–¼</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('guideList').innerHTML = guideListHtml;
                
                // 5. ëª¨ë‹¬ í‘œì‹œ
                document.getElementById('editFeaturedModal').classList.remove('hidden');
                
                // 6. ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                document.getElementById('saveFeaturedBtn').onclick = async () => {
                    const title = document.getElementById('editTitle').value;
                    const sender = document.getElementById('editSender').value;
                    const location = document.getElementById('editLocation').value;
                    const date = document.getElementById('editDate').value;
                    
                    if (!title || !sender || !location || !date) {
                        alert('âŒ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    // ê°€ì´ë“œ ìˆœì„œ ê°€ì ¸ì˜¤ê¸° (UUID ë¬¸ìì—´ë¡œ ìœ ì§€)
                    const guideItems = document.querySelectorAll('.guide-item');
                    const newGuideIds = Array.from(guideItems).map(item => item.dataset.guideId);
                    
                    try {
                        const response = await fetch(`/api/admin/shares/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                title,
                                sender,
                                location,
                                date,
                                guideIds: newGuideIds
                            })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'í¸ì§‘ ì‹¤íŒ¨');
                        }
                        
                        const result = await response.json();
                        alert('âœ… ' + result.message);
                        closeEditModal();
                        loadFeaturedList();
                    } catch (error) {
                        console.error('Featured í¸ì§‘ ì˜¤ë¥˜:', error);
                        alert('âŒ í¸ì§‘ ì‹¤íŒ¨: ' + error.message);
                    }
                };
            } catch (error) {
                console.error('Featured í¸ì§‘ ì˜¤ë¥˜:', error);
                alert('âŒ í¸ì§‘ ì‹¤íŒ¨: ' + error.message);
            }
        };

        // ëª¨ë‹¬ ë‹«ê¸°
        window.closeEditModal = function() {
            document.getElementById('editFeaturedModal').classList.add('hidden');
        };

        // ê°€ì´ë“œ ìœ„ë¡œ ì´ë™ (ëª¨ë°”ì¼ ì¹œí™”ì )
        window.moveGuideUp = function(button) {
            const item = button.closest('.guide-item');
            const prev = item.previousElementSibling;
            if (prev) {
                item.parentNode.insertBefore(item, prev);
                updateGuideNumbers();
            }
        };

        // ê°€ì´ë“œ ì•„ë˜ë¡œ ì´ë™ (ëª¨ë°”ì¼ ì¹œí™”ì )
        window.moveGuideDown = function(button) {
            const item = button.closest('.guide-item');
            const next = item.nextElementSibling;
            if (next) {
                item.parentNode.insertBefore(next, item);
                updateGuideNumbers();
            }
        };

        // ê°€ì´ë“œ ë²ˆí˜¸ ë° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateGuideNumbers() {
            const items = document.querySelectorAll('.guide-item');
            items.forEach((item, index) => {
                // ë²ˆí˜¸ ì—…ë°ì´íŠ¸
                const label = item.querySelector('span.font-medium');
                if (label) label.textContent = `ê°€ì´ë“œ ${index + 1}`;
                
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                const upBtn = item.querySelector('button:first-of-type');
                const downBtn = item.querySelector('button:last-of-type');
                
                upBtn.disabled = (index === 0);
                downBtn.disabled = (index === items.length - 1);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ê°€ì´ë“œ ê´€ë¦¬ í•¨ìˆ˜
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let allGuides = [];
        let displayedGuides = 0;
        const GUIDES_PER_PAGE = 30;
        let selectedGuideIds = new Set();

        async function searchGuides() {
            const locationSearch = document.getElementById('guideLocationSearch').value.trim();
            const tagsSearch = document.getElementById('guideTagsSearch').value.trim();
            
            const params = new URLSearchParams();
            if (locationSearch) params.append('locationName', locationSearch);
            if (tagsSearch) params.append('tags', tagsSearch);
            params.append('limit', GUIDES_PER_PAGE);
            params.append('offset', 0);
            
            try {
                const res = await fetch(`/api/admin/guides?${params}`);
                if (!res.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨');
                
                const data = await res.json();
                allGuides = data.guides;
                displayedGuides = allGuides.length;
                
                document.getElementById('guideCount').textContent = `ì´ ${data.total}ê°œ`;
                renderGuides();
            } catch (error) {
                console.error('ê°€ì´ë“œ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('ê°€ì´ë“œ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function renderGuides() {
            const grid = document.getElementById('guidesGrid');
            if (!grid) return;
            
            if (allGuides.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            grid.innerHTML = allGuides.map(guide => `
                <div class="border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition ${selectedGuideIds.has(guide.id) ? 'ring-2 ring-blue-500' : ''}">
                    <div class="relative">
                        <img src="${guide.imageUrl || '/placeholder.jpg'}" alt="${guide.title}" class="w-full h-48 object-cover">
                        <label class="absolute top-2 right-2 cursor-pointer">
                            <input type="checkbox" class="w-5 h-5 rounded" ${selectedGuideIds.has(guide.id) ? 'checked' : ''} onchange="toggleGuideSelection('${guide.id}')">
                        </label>
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-900 mb-2 truncate">${guide.title}</h3>
                        <p class="text-sm text-gray-500 mb-2">${guide.locationName || 'ìœ„ì¹˜ ì—†ìŒ'}</p>
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${(guide.tags || []).map(tag => `
                                <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">${tag}</span>
                            `).join('')}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editGuideTags('${guide.id}')" class="flex-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded transition text-sm">
                                íƒœê·¸ í¸ì§‘
                            </button>
                            <button onclick="deleteGuide('${guide.id}')" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded transition text-sm">
                                ì‚­ì œ
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateSelectionUI();
        }

        async function editGuideTags(guideId) {
            const guide = allGuides.find(g => g.id === guideId);
            if (!guide) return;
            
            const currentTags = (guide.tags || []).join(', ');
            const newTagsStr = prompt(`íƒœê·¸ í¸ì§‘ (ì‰¼í‘œë¡œ êµ¬ë¶„)\\n\\ní˜„ì¬ íƒœê·¸: ${currentTags || 'ì—†ìŒ'}`, currentTags);
            
            if (newTagsStr === null) return;
            
            const newTags = newTagsStr.split(',').map(t => t.trim()).filter(t => t);
            
            try {
                const res = await fetch(`/api/admin/guides/${guideId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tags: newTags })
                });
                
                if (!res.ok) throw new Error('íƒœê·¸ í¸ì§‘ ì‹¤íŒ¨');
                
                alert('âœ… íƒœê·¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                searchGuides();
            } catch (error) {
                console.error('íƒœê·¸ í¸ì§‘ ì˜¤ë¥˜:', error);
                alert('íƒœê·¸ í¸ì§‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function deleteGuide(guideId) {
            const guide = allGuides.find(g => g.id === guideId);
            if (!guide) return;
            
            const guideName = guide.title || guide.locationName || 'ì´ ê°€ì´ë“œ';
            if (!confirm(`"${guideName}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
            
            try {
                const res = await fetch(`/api/admin/guides/${guideId}`, {
                    method: 'DELETE'
                });
                
                if (!res.ok) throw new Error('ê°€ì´ë“œ ì‚­ì œ ì‹¤íŒ¨');
                
                alert('âœ… ê°€ì´ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                // ì„ íƒëœ ê°€ì´ë“œ ëª©ë¡ì—ì„œë„ ì œê±°
                selectedGuideIds.delete(guideId);
                
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                searchGuides();
            } catch (error) {
                console.error('ê°€ì´ë“œ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ê°€ì´ë“œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function toggleGuideSelection(guideId) {
            if (selectedGuideIds.has(guideId)) {
                selectedGuideIds.delete(guideId);
            } else {
                selectedGuideIds.add(guideId);
            }
            renderGuides();
        }

        function updateSelectionUI() {
            const count = selectedGuideIds.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('createShareBtn').disabled = count === 0;
        }

        function openCreateShareModal() {
            const name = prompt(`ê³µìœ  í˜ì´ì§€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”\n\nì„ íƒí•œ ê°€ì´ë“œ: ${selectedGuideIds.size}ê°œ`);
            if (!name || name.trim().length === 0) return;
            
            createShareFromGuides(name.trim());
        }

        async function createShareFromGuides(name) {
            try {
                const res = await fetch('/api/admin/create-share-from-guides', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        guideIds: Array.from(selectedGuideIds),
                        name
                    })
                });
                
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.error || 'ê³µìœ  í˜ì´ì§€ ìƒì„± ì‹¤íŒ¨');
                }
                
                const data = await res.json();
                alert(`ê³µìœ  í˜ì´ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n${data.shareUrl}`);
                
                selectedGuideIds.clear();
                renderGuides();
            } catch (error) {
                console.error('ê³µìœ  í˜ì´ì§€ ìƒì„± ì˜¤ë¥˜:', error);
                alert('ê³µìœ  í˜ì´ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function resetGuideFilters() {
            document.getElementById('guideLocationSearch').value = '';
            document.getElementById('guideTagsSearch').value = '';
            searchGuides();
        }

        async function loadMoreGuides() {
            const locationSearch = document.getElementById('guideLocationSearch').value.trim();
            const tagsSearch = document.getElementById('guideTagsSearch').value.trim();
            
            const params = new URLSearchParams();
            if (locationSearch) params.append('locationName', locationSearch);
            if (tagsSearch) params.append('tags', tagsSearch);
            params.append('limit', GUIDES_PER_PAGE);
            params.append('offset', displayedGuides);
            
            try {
                const res = await fetch(`/api/admin/guides?${params}`);
                if (!res.ok) throw new Error('ë¡œë“œ ì‹¤íŒ¨');
                
                const data = await res.json();
                allGuides = [...allGuides, ...data.guides];
                displayedGuides = allGuides.length;
                
                renderGuides();
            } catch (error) {
                console.error('ë” ë³´ê¸° ì˜¤ë¥˜:', error);
                alert('ë” ë³´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Featured ê°¤ëŸ¬ë¦¬ ê´€ë¦¬ í•¨ìˆ˜
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let allSharePages = [];
        let currentFeaturedPages = [];

        async function searchFeaturedShares() {
            const query = document.getElementById('featuredShareSearch').value.trim();
            
            try {
                const res = await fetch(`/api/admin/shares?search=${encodeURIComponent(query)}`);
                if (!res.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨');
                
                const data = await res.json();
                allSharePages = data.shares;
                renderFeaturedSearchResults();
            } catch (error) {
                console.error('ê³µìœ  í˜ì´ì§€ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
        }

        function renderFeaturedSearchResults() {
            const list = document.getElementById('featuredSharesList');
            if (!list) return;
            
            if (allSharePages.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            list.innerHTML = allSharePages.map(share => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900 truncate">${share.name}</p>
                        <p class="text-sm text-gray-500">ì¡°íšŒìˆ˜: ${share.downloadCount || 0}</p>
                    </div>
                    <button onclick="addToFeatured('${share.id}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition">
                        ì¶”ê°€
                    </button>
                </div>
            `).join('');
        }

        async function loadCurrentFeatured() {
            try {
                const res = await fetch('/api/featured');
                if (!res.ok) throw new Error('Featured ë¡œë“œ ì‹¤íŒ¨');
                
                const data = await res.json();
                currentFeaturedPages = data.featured || [];
                renderCurrentFeatured();
            } catch (error) {
                console.error('Featured ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function renderCurrentFeatured() {
            const list = document.getElementById('currentFeaturedList');
            const countDisplay = document.getElementById('featuredCountDisplay');
            if (!list || !countDisplay) return;
            
            countDisplay.textContent = `${currentFeaturedPages.length}/3`;
            
            if (currentFeaturedPages.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Featured í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            list.innerHTML = currentFeaturedPages.map(page => `
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                    <div class="flex-1 min-w-0">
                        <p class="font-medium text-gray-900 truncate">${page.name}</p>
                        <p class="text-sm text-gray-500">ìˆœì„œ: ${page.featuredOrder || '-'}</p>
                    </div>
                    <button onclick="removeFromFeatured('${page.id}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded transition">
                        ì œê±°
                    </button>
                </div>
            `).join('');
        }

        async function addToFeatured(shareId) {
            if (currentFeaturedPages.length >= 3) {
                alert('FeaturedëŠ” ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const res = await fetch(`/api/admin/shares/${shareId}/featured`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ featured: true })
                });
                
                if (!res.ok) throw new Error('Featured ì¶”ê°€ ì‹¤íŒ¨');
                
                alert('Featuredì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                await loadCurrentFeatured();
            } catch (error) {
                console.error('Featured ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('Featured ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function removeFromFeatured(shareId) {
            if (!confirm('Featuredì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const res = await fetch(`/api/admin/shares/${shareId}/featured`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ featured: false })
                });
                
                if (!res.ok) throw new Error('Featured ì œê±° ì‹¤íŒ¨');
                
                alert('Featuredì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadCurrentFeatured();
            } catch (error) {
                console.error('Featured ì œê±° ì˜¤ë¥˜:', error);
                alert('Featured ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('featuredShareSearch');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    if (searchInput.value.trim().length > 0) {
                        searchFeaturedShares();
                    }
                });
            }
        });

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        async function init() {
            try {
                // ìš”ì•½ ë°ì´í„° ë¡œë“œ
                const res = await fetch('/api/admin/overview', {
                    credentials: 'include'
                });
                
                // 401 ì—ëŸ¬ ì‹œ ë¡œê·¸ì¸ í”„ë¡¬í”„íŠ¸
                if (res.status === 401) {
                    await promptAdminLogin();
                    return init(); // ë¡œê·¸ì¸ í›„ ì¬ì‹œë„
                }
                
                if (!res.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                const data = await res.json();
                
                renderOverview(data);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content-overview').classList.remove('hidden');
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                document.getElementById('loading').innerHTML = `
                    <p class="text-red-600">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p>
                    <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                `;
            }
        }
        
        // ê´€ë¦¬ì ë¡œê·¸ì¸ í”„ë¡¬í”„íŠ¸
        async function promptAdminLogin() {
            const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!password) {
                throw new Error('ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
            
            const res = await fetch('/api/admin/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ password })
            });
            
            if (!res.ok) {
                alert('âŒ ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.');
                throw new Error('ì¸ì¦ ì‹¤íŒ¨');
            }
            
            const data = await res.json();
            console.log('âœ… ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ:', data);
        }

        // ìš”ì•½ ë Œë”ë§
        function renderOverview(data) {
            document.getElementById('totalUsers').textContent = data.totalUsers.toLocaleString();
            document.getElementById('recentUsers').textContent = data.recentUsers.toLocaleString();
            document.getElementById('totalApiCalls').textContent = data.totalApiCalls.toLocaleString();
            document.getElementById('estimatedCost').textContent = `â‚©${Math.round(data.estimatedCost * 1300).toLocaleString()}`;
            document.getElementById('totalShares').textContent = data.totalShares.toLocaleString();
            document.getElementById('totalViews').textContent = data.totalViews.toLocaleString();
            
            // ë¡œê·¸ì¸ ë°©ì‹
            const providerHtml = data.providers.map(p => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="font-medium text-gray-700">${p.provider === 'google' ? 'Google' : p.provider === 'kakao' ? 'Kakao' : 'Replit'}</span>
                    <span class="font-bold text-gray-900">${p.count}ëª…</span>
                </div>
            `).join('');
            document.getElementById('providerStats').innerHTML = providerHtml;
        }

        // ì¶”ì²œ ê°¤ëŸ¬ë¦¬ ë¡œë“œ
        async function loadFeatured() {
            try {
                const res = await fetch('/api/admin/featured');
                if (!res.ok) throw new Error('ì¶”ì²œ ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨');
                const data = await res.json();
                renderFeatured(data.featured);
            } catch (error) {
                console.error('ì¶”ì²œ ê°¤ëŸ¬ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì¶”ì²œ ê°¤ëŸ¬ë¦¬ ë Œë”ë§
        function renderFeatured(featured) {
            const html = featured.map(item => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">${item.name}</h3>
                        <p class="text-sm text-gray-500">${new Date(item.createdAt).toLocaleDateString('ko-KR')}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.open('/s/${item.id}', '_blank')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg transition">
                            ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button onclick="removeFeatured('${item.id}')" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white text-sm rounded-lg transition">
                            ì œê±°
                        </button>
                    </div>
                </div>
            `).join('');
            document.getElementById('featuredList').innerHTML = html || '<p class="text-center text-gray-500 py-8">ì¶”ì²œ ê°¤ëŸ¬ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        // ì „ì²´ ê³µìœ  ë¡œë“œ
        async function loadAllShares() {
            try {
                const res = await fetch('/api/admin/content/all-shares');
                if (!res.ok) throw new Error('ì „ì²´ ê³µìœ  ë¡œë“œ ì‹¤íŒ¨');
                const data = await res.json();
                allShares = data.shares;
                displayedShares = 0;
                renderAllShares();
            } catch (error) {
                console.error('ì „ì²´ ê³µìœ  ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì „ì²´ ê³µìœ  ë Œë”ë§
        function renderAllShares() {
            const end = Math.min(displayedShares + SHARES_PER_PAGE, allShares.length);
            const shares = allShares.slice(displayedShares, end);
            
            const html = shares.map(item => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900">${item.name}</h3>
                        <p class="text-sm text-gray-500">${new Date(item.createdAt).toLocaleDateString('ko-KR')} | ì¡°íšŒìˆ˜: ${item.downloadCount || 0}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.open('/s/${item.id}', '_blank')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg transition">
                            ë¯¸ë¦¬ë³´ê¸°
                        </button>
                        <button onclick="deleteShare('${item.id}')" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg transition">
                            ì‚­ì œ
                        </button>
                    </div>
                </div>
            `).join('');
            
            if (displayedShares === 0) {
                document.getElementById('allSharesList').innerHTML = html || '<p class="text-center text-gray-500 py-8">ê³µìœ  í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                document.getElementById('allSharesList').insertAdjacentHTML('beforeend', html);
            }
            
            displayedShares = end;
            document.getElementById('loadMoreBtn').style.display = displayedShares >= allShares.length ? 'none' : 'block';
        }

        // ë” ë³´ê¸°
        function loadMore() {
            renderAllShares();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â­ Phase 1: í…œí”Œë¦¿ v1 â†’ v2 ì¼ê´„ ë§ˆì´ê·¸ë ˆì´ì…˜ (2025-11-13)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function migrateToV2() {
            if (!confirm('ëª¨ë“  ê³µìœ í˜ì´ì§€ë¥¼ v2 í…œí”Œë¦¿ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€¢ URL ë¶ˆë³€ (ì¹´ì¹´ì˜¤í†¡ ë§í¬ ì •ìƒ)\nâ€¢ v2.js ìˆ˜ì • ì‹œ ëª¨ë“  í˜ì´ì§€ ì¼ê´„ ì ìš©\nâ€¢ íŒŒì¼ í¬ê¸° 90% ê°ì†Œ')) {
                return;
            }

            try {
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

                const res = await fetch('/api/admin/migrate-to-v2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!res.ok) {
                    throw new Error('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨');
                }

                const data = await res.json();
                alert(`âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!\n\n${data.message}`);
                
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                location.reload();
            } catch (error) {
                console.error('ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜:', error);
                alert('âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                const res = await fetch('/api/admin/stats');
                if (!res.ok) throw new Error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨');
                const data = await res.json();
                renderStats(data);
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // í†µê³„ ë Œë”ë§
        function renderStats(data) {
            // ì¼ë³„ ì¶”ì´
            const trendsHtml = data.dailyTrends && data.dailyTrends.length > 0
                ? data.dailyTrends.map(day => `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-4 text-sm text-gray-700">${new Date(day.date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}</td>
                        <td class="py-3 px-4 text-sm text-center font-semibold text-gray-900">${day.newUsers}</td>
                        <td class="py-3 px-4 text-sm text-center font-semibold text-gray-900">${day.apiCalls}</td>
                        <td class="py-3 px-4 text-sm text-center font-semibold text-gray-900">${day.shares}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="4" class="py-8 text-center text-gray-500">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (AI í˜¸ì¶œ ë° ì‚¬ìš©ì í™œë™ ë¡œê·¸ ìˆ˜ì§‘ ì „)</td></tr>';
            document.getElementById('dailyTrends').innerHTML = trendsHtml;

            // ë””ë°”ì´ìŠ¤
            const deviceHtml = data.devices && data.devices.length > 0
                ? data.devices.map(d => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-sm text-gray-700">${d.type}</span>
                        <span class="text-sm font-semibold text-gray-900">${d.count} (${d.percentage}%)</span>
                    </div>
                `).join('')
                : '<p class="text-sm text-center text-gray-500 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
            document.getElementById('deviceStats').innerHTML = deviceHtml;

            // ë¸Œë¼ìš°ì €
            const browserHtml = data.browsers && data.browsers.length > 0
                ? data.browsers.map(b => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-sm text-gray-700">${b.name}</span>
                        <span class="text-sm font-semibold text-gray-900">${b.count} (${b.percentage}%)</span>
                    </div>
                `).join('')
                : '<p class="text-sm text-center text-gray-500 py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
            document.getElementById('browserStats').innerHTML = browserHtml;

            // AI ì„±ëŠ¥
            document.getElementById('avgResponseTime').textContent = data.aiPerformance.avgResponseTime || data.aiPerformance.avgResponseTime === 0 ? `${data.aiPerformance.avgResponseTime}ms` : '-';
            document.getElementById('successRate').textContent = data.aiPerformance.successRate || data.aiPerformance.successRate === 0 ? `${data.aiPerformance.successRate}%` : '-';
            document.getElementById('errorRate').textContent = data.aiPerformance.errorRate || data.aiPerformance.errorRate === 0 ? `${data.aiPerformance.errorRate}%` : '-';
        }

        // Featured ì œê±°
        async function removeFeatured(id) {
            if (!confirm('ì¶”ì²œ ê°¤ëŸ¬ë¦¬ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const res = await fetch(`/api/admin/featured/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('ì œê±° ì‹¤íŒ¨');
                alert('ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadFeatured();
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ê³µìœ  ì‚­ì œ
        async function deleteShare(id) {
            const share = allShares.find(s => s.id === id);
            const name = share ? share.name : 'ê³µìœ  í˜ì´ì§€';
            
            if (!confirm(`"${name}" ê³µìœ  í˜ì´ì§€ë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
            if (!confirm(`ìµœì¢… í™•ì¸: ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const res = await fetch(`/api/admin/shares/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
                const result = await res.json();
                alert(result.message);
                loadAllShares();
            } catch (error) {
                alert('ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('featuredSearch')?.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('#featuredList > div').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(query) ? 'flex' : 'none';
                });
            });

            document.getElementById('allSharesSearch')?.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                document.querySelectorAll('#allSharesList > div').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(query) ? 'flex' : 'none';
                });
            });
        });

        // ì´ˆê¸°í™”
        init();
    </script>

    <!-- Featured í¸ì§‘ ëª¨ë‹¬ (from index.html) -->
    <div id="editFeaturedModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <!-- ëª¨ë‹¬ í—¤ë” -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">âœï¸ Featured í¸ì§‘</h2>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- ëª¨ë‹¬ ë°”ë”” -->
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 200px);">
                <!-- ì…ë ¥ í•„ë“œ -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì œëª©</label>
                        <input id="editTitle" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ë°œì‹ ì</label>
                        <input id="editSender" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ìœ„ì¹˜</label>
                        <input id="editLocation" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ë‚ ì§œ</label>
                        <input id="editDate" type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                    </div>
                </div>

                <!-- ê°€ì´ë“œ ëª©ë¡ -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ“¸ ì½˜í…ì¸  ìˆœì„œ (â–²â–¼ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½)</h3>
                    <p class="text-sm text-gray-500 mb-3">ì—¬í–‰ ë™ì„ ì´ë‚˜ í•˜ì´ë¼ì´íŠ¸ ìˆœì„œëŒ€ë¡œ ë°°ì¹˜í•˜ì„¸ìš” (ìµœëŒ€ 20ê°œ)</p>
                    <div id="guideList" class="space-y-2 p-4 bg-gray-50 rounded-lg" style="max-height: 70vh; overflow-y: auto;">
                        <!-- ë™ì  ìƒì„± -->
                    </div>
                </div>
            </div>

            <!-- ëª¨ë‹¬ í‘¸í„° -->
            <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
                <button onclick="closeEditModal()" class="px-6 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 font-semibold transition-colors">
                    ì·¨ì†Œ
                </button>
                <button id="saveFeaturedBtn" class="px-6 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold transition-all shadow-lg">
                    ğŸ’¾ ì €ì¥ ë° HTML ì¬ìƒì„±
                </button>
            </div>
        </div>
    </div>
</body>
</html>
